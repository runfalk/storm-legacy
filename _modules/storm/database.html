
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>storm.database &#8212; Storm  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for storm.database</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Copyright (c) 2006, 2007 Canonical</span>
<span class="c1">#</span>
<span class="c1"># Written by Gustavo Niemeyer &lt;gustavo@niemeyer.net&gt;</span>
<span class="c1">#</span>
<span class="c1"># This file is part of Storm Object Relational Mapper.</span>
<span class="c1">#</span>
<span class="c1"># Storm is free software; you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Lesser General Public License as</span>
<span class="c1"># published by the Free Software Foundation; either version 2.1 of</span>
<span class="c1"># the License, or (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># Storm is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Lesser General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Lesser General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>

<span class="sd">&quot;&quot;&quot;Basic database interfacing mechanisms for Storm.</span>

<span class="sd">This is the common code for database support; specific databases are</span>
<span class="sd">supported in modules in L{storm.databases}.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">importlib</span> <span class="k">import</span> <span class="n">import_module</span>

<span class="kn">from</span> <span class="nn">storm.compat</span> <span class="k">import</span> <span class="n">iter_range</span><span class="p">,</span> <span class="n">string_types</span><span class="p">,</span> <span class="n">ustr</span>
<span class="kn">from</span> <span class="nn">storm.expr</span> <span class="k">import</span> <span class="n">Expr</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="nb">compile</span>
<span class="c1"># Circular import: imported at the end of the module.</span>
<span class="c1"># from storm.tracer import trace</span>
<span class="kn">from</span> <span class="nn">storm.variables</span> <span class="k">import</span> <span class="n">Variable</span>
<span class="kn">from</span> <span class="nn">storm.xid</span> <span class="k">import</span> <span class="n">Xid</span>
<span class="kn">from</span> <span class="nn">storm.exceptions</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ClosedError</span><span class="p">,</span> <span class="n">ConnectionBlockedError</span><span class="p">,</span> <span class="n">DatabaseError</span><span class="p">,</span> <span class="n">DisconnectionError</span><span class="p">,</span>
    <span class="n">Error</span><span class="p">,</span> <span class="n">ProgrammingError</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">storm.uri</span> <span class="k">import</span> <span class="n">URI</span>
<span class="kn">import</span> <span class="nn">storm</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Database&quot;</span><span class="p">,</span> <span class="s2">&quot;Connection&quot;</span><span class="p">,</span> <span class="s2">&quot;Result&quot;</span><span class="p">,</span>
           <span class="s2">&quot;convert_param_marks&quot;</span><span class="p">,</span> <span class="s2">&quot;create_database&quot;</span><span class="p">,</span> <span class="s2">&quot;register_scheme&quot;</span><span class="p">]</span>


<span class="n">STATE_CONNECTED</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">STATE_DISCONNECTED</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">STATE_RECONNECT</span> <span class="o">=</span> <span class="mi">3</span>


<div class="viewcode-block" id="Result"><a class="viewcode-back" href="../../databases.html#storm.database.Result">[docs]</a><span class="k">class</span> <span class="nc">Result</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A representation of the results from a single SQL statement.&quot;&quot;&quot;</span>

    <span class="n">_closed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">raw_cursor</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="n">connection</span> <span class="c1"># Ensures deallocation order.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_cursor</span> <span class="o">=</span> <span class="n">raw_cursor</span>
        <span class="k">if</span> <span class="n">raw_cursor</span><span class="o">.</span><span class="n">arraysize</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Default of 1 is silly.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raw_cursor</span><span class="o">.</span><span class="n">arraysize</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the cursor.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

<div class="viewcode-block" id="Result.close"><a class="viewcode-back" href="../../databases.html#storm.database.Result.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the underlying raw cursor, if it hasn&#39;t already been closed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raw_cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raw_cursor</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Result.get_one"><a class="viewcode-back" href="../../databases.html#storm.database.Result.get_one">[docs]</a>    <span class="k">def</span> <span class="nf">get_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch one result from the cursor.</span>

<span class="sd">        The result will be converted to an appropriate format via</span>
<span class="sd">        L{from_database}.</span>

<span class="sd">        @raise DisconnectionError: Raised when the connection is lost.</span>
<span class="sd">            Reconnection happens automatically on rollback.</span>

<span class="sd">        @return: A converted row or None, if no data is left.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">_check_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">from_database</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Result.get_all"><a class="viewcode-back" href="../../databases.html#storm.database.Result.get_all">[docs]</a>    <span class="k">def</span> <span class="nf">get_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch all results from the cursor.</span>

<span class="sd">        The results will be converted to an appropriate format via</span>
<span class="sd">        L{from_database}.</span>

<span class="sd">        @raise DisconnectionError: Raised when the connection is lost.</span>
<span class="sd">            Reconnection happens automatically on rollback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">_check_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">from_database</span><span class="p">(</span><span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield all results, one at a time.</span>

<span class="sd">        The results will be converted to an appropriate format via</span>
<span class="sd">        L{from_database}.</span>

<span class="sd">        @raise DisconnectionError: Raised when the connection is lost.</span>
<span class="sd">            Reconnection happens automatically on rollback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">_check_disconnect</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raw_cursor</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">yield</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">from_database</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rowcount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See PEP 249 for further details on rowcount.</span>

<span class="sd">        @return: the number of affected rows, or None if the database</span>
<span class="sd">            backend does not provide this information. Return value</span>
<span class="sd">            is undefined if all results have not yet been retrieved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_cursor</span><span class="o">.</span><span class="n">rowcount</span>

<div class="viewcode-block" id="Result.get_insert_identity"><a class="viewcode-back" href="../../databases.html#storm.database.Result.get_insert_identity">[docs]</a>    <span class="k">def</span> <span class="nf">get_insert_identity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primary_columns</span><span class="p">,</span> <span class="n">primary_variables</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a query which will return the row that was just inserted.</span>

<span class="sd">        This must be overridden in database-specific subclasses.</span>

<span class="sd">        @rtype: L{storm.expr.Expr}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Result.set_variable"><a class="viewcode-back" href="../../databases.html#storm.database.Result.set_variable">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">set_variable</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the given variable&#39;s value from the database.&quot;&quot;&quot;</span>
        <span class="n">variable</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">from_db</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Result.from_database"><a class="viewcode-back" href="../../databases.html#storm.database.Result.from_database">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_database</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a row fetched from the database to an agnostic format.</span>

<span class="sd">        This method is intended to be overridden in subclasses, but</span>
<span class="sd">        not called externally.</span>

<span class="sd">        If there are any peculiarities in the datatypes returned from</span>
<span class="sd">        a database backend, this method should be overridden in the</span>
<span class="sd">        backend subclass to convert them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">row</span></div></div>


<div class="viewcode-block" id="Connection"><a class="viewcode-back" href="../../databases.html#storm.database.Connection">[docs]</a><span class="k">class</span> <span class="nc">Connection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A connection to a database.</span>

<span class="sd">    @cvar result_factory: A callable which takes this L{Connection}</span>
<span class="sd">        and the backend cursor and returns an instance of L{Result}.</span>
<span class="sd">    @type param_mark: C{str}</span>
<span class="sd">    @cvar param_mark: The dbapi paramstyle that the database backend expects.</span>
<span class="sd">    @type compile: L{storm.expr.Compile}</span>
<span class="sd">    @cvar compile: The compiler to use for connections of this type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">result_factory</span> <span class="o">=</span> <span class="n">Result</span>
    <span class="n">param_mark</span> <span class="o">=</span> <span class="s2">&quot;?&quot;</span>
    <span class="nb">compile</span> <span class="o">=</span> <span class="nb">compile</span>

    <span class="n">_blocked</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_closed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_two_phase_transaction</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># If True, a two-phase transaction has</span>
                                    <span class="c1"># been started with begin()</span>
    <span class="n">_state</span> <span class="o">=</span> <span class="n">STATE_CONNECTED</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_database</span> <span class="o">=</span> <span class="n">database</span> <span class="c1"># Ensures deallocation order.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event</span> <span class="o">=</span> <span class="n">event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database</span><span class="o">.</span><span class="n">raw_connect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the connection.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

<div class="viewcode-block" id="Connection.block_access"><a class="viewcode-back" href="../../databases.html#storm.database.Connection.block_access">[docs]</a>    <span class="k">def</span> <span class="nf">block_access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Block access to the connection.</span>

<span class="sd">        Attempts to execute statements or commit a transaction will</span>
<span class="sd">        result in a C{ConnectionBlockedError} exception.  Rollbacks</span>
<span class="sd">        are permitted as that operation is often used in case of</span>
<span class="sd">        failures.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocked</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Connection.unblock_access"><a class="viewcode-back" href="../../databases.html#storm.database.Connection.unblock_access">[docs]</a>    <span class="k">def</span> <span class="nf">unblock_access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unblock access to the connection.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocked</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Connection.execute"><a class="viewcode-back" href="../../databases.html#storm.database.Connection.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noresult</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute a statement with the given parameters.</span>

<span class="sd">        @type statement: L{Expr} or C{str}</span>
<span class="sd">        @param statement: The statement to execute. It will be</span>
<span class="sd">            compiled if necessary.</span>
<span class="sd">        @param noresult: If True, no result will be returned.</span>

<span class="sd">        @raise ConnectionBlockedError: Raised if access to the connection</span>
<span class="sd">            has been blocked with L{block_access}.</span>
<span class="sd">        @raise DisconnectionError: Raised when the connection is lost.</span>
<span class="sd">            Reconnection happens automatically on rollback.</span>

<span class="sd">        @return: The result of C{self.result_factory}, or None if</span>
<span class="sd">            C{noresult} is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ClosedError</span><span class="p">(</span><span class="s2">&quot;Connection is closed&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocked</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConnectionBlockedError</span><span class="p">(</span><span class="s2">&quot;Access to connection is blocked&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_event</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;register-transaction&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connected</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">Expr</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t pass parameters with expressions&quot;</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
            <span class="n">statement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">statement</span> <span class="o">=</span> <span class="n">convert_param_marks</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_mark</span><span class="p">)</span>
        <span class="n">raw_cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_execute</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">noresult</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_disconnect</span><span class="p">(</span><span class="n">raw_cursor</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_factory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_cursor</span><span class="p">)</span></div>

<div class="viewcode-block" id="Connection.close"><a class="viewcode-back" href="../../databases.html#storm.database.Connection.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the connection if it is not already closed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raw_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raw_connection</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Connection.begin"><a class="viewcode-back" href="../../databases.html#storm.database.Connection.begin">[docs]</a>    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Begin a two-phase transaction.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_two_phase_transaction</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProgrammingError</span><span class="p">(</span><span class="s2">&quot;begin cannot be used inside a transaction&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connected</span><span class="p">()</span>
        <span class="n">raw_xid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_xid</span><span class="p">(</span><span class="n">xid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_connection</span><span class="o">.</span><span class="n">tpc_begin</span><span class="p">,</span> <span class="n">raw_xid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_two_phase_transaction</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Connection.prepare"><a class="viewcode-back" href="../../databases.html#storm.database.Connection.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the prepare phase of a two-phase transaction.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_two_phase_transaction</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProgrammingError</span><span class="p">(</span><span class="s2">&quot;prepare must be called inside a two-phase &quot;</span>
                                   <span class="s2">&quot;transaction&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_connection</span><span class="o">.</span><span class="n">tpc_prepare</span><span class="p">)</span></div>

<div class="viewcode-block" id="Connection.commit"><a class="viewcode-back" href="../../databases.html#storm.database.Connection.commit">[docs]</a>    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Commit the connection.</span>

<span class="sd">        @param xid: Optionally the L{Xid} of a previously prepared</span>
<span class="sd">             transaction to commit. This form should be called outside</span>
<span class="sd">             of a transaction, and is intended for use in recovery.</span>

<span class="sd">        @raise ConnectionBlockedError: Raised if access to the connection</span>
<span class="sd">            has been blocked with L{block_access}.</span>
<span class="sd">        @raise DisconnectionError: Raised when the connection is lost.</span>
<span class="sd">            Reconnection happens automatically on rollback.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connected</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">xid</span><span class="p">:</span>
                <span class="n">raw_xid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_xid</span><span class="p">(</span><span class="n">xid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_connection</span><span class="o">.</span><span class="n">tpc_commit</span><span class="p">,</span> <span class="n">raw_xid</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_two_phase_transaction</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_connection</span><span class="o">.</span><span class="n">tpc_commit</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_two_phase_transaction</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_connection</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_disconnect</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="s2">&quot;connection_commit&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">)</span></div>

<div class="viewcode-block" id="Connection.recover"><a class="viewcode-back" href="../../databases.html#storm.database.Connection.recover">[docs]</a>    <span class="k">def</span> <span class="nf">recover</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of L{Xid}s representing pending transactions.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connected</span><span class="p">()</span>
        <span class="n">raw_xids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_connection</span><span class="o">.</span><span class="n">tpc_recover</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Xid</span><span class="p">(</span><span class="n">raw_xid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">raw_xid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">raw_xid</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">raw_xid</span> <span class="ow">in</span> <span class="n">raw_xids</span><span class="p">]</span></div>

<div class="viewcode-block" id="Connection.rollback"><a class="viewcode-back" href="../../databases.html#storm.database.Connection.rollback">[docs]</a>    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rollback the connection.</span>

<span class="sd">        @param xid: Optionally the L{Xid} of a previously prepared</span>
<span class="sd">             transaction to rollback. This form should be called outside</span>
<span class="sd">             of a transaction, and is intended for use in recovery.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">STATE_CONNECTED</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">xid</span><span class="p">:</span>
                        <span class="n">raw_xid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_xid</span><span class="p">(</span><span class="n">xid</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_connection</span><span class="o">.</span><span class="n">tpc_rollback</span><span class="p">(</span><span class="n">raw_xid</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_two_phase_transaction</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_connection</span><span class="o">.</span><span class="n">tpc_rollback</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_connection</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_disconnection_error</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_connection</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">STATE_RECONNECT</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_two_phase_transaction</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_two_phase_transaction</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_two_phase_transaction</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">STATE_RECONNECT</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_disconnect</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="s2">&quot;connection_rollback&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">)</span></div>

<div class="viewcode-block" id="Connection.to_database"><a class="viewcode-back" href="../../databases.html#storm.database.Connection.to_database">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">to_database</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert some parameters into values acceptable to a database backend.</span>

<span class="sd">        It is acceptable to override this method in subclasses, but it</span>
<span class="sd">        is not intended to be used externally.</span>

<span class="sd">        This delegates conversion to any L{Variable}s in the parameter</span>
<span class="sd">        list, and passes through all other values untouched.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">Variable</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">to_db</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">param</span></div>

<div class="viewcode-block" id="Connection.build_raw_cursor"><a class="viewcode-back" href="../../databases.html#storm.database.Connection.build_raw_cursor">[docs]</a>    <span class="k">def</span> <span class="nf">build_raw_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a new dbapi cursor object.</span>

<span class="sd">        It is acceptable to override this method in subclasses, but it</span>
<span class="sd">        is not intended to be called externally.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span></div>

<div class="viewcode-block" id="Connection.raw_execute"><a class="viewcode-back" href="../../databases.html#storm.database.Connection.raw_execute">[docs]</a>    <span class="k">def</span> <span class="nf">raw_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute a raw statement with the given parameters.</span>

<span class="sd">        It&#39;s acceptable to override this method in subclasses, but it</span>
<span class="sd">        is not intended to be called externally.</span>

<span class="sd">        If the global C{DEBUG} is True, the statement will be printed</span>
<span class="sd">        to standard out.</span>

<span class="sd">        @return: The dbapi cursor object, as fetched from L{build_raw_cursor}.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">raw_cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_raw_cursor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_execution</span><span class="p">(</span><span class="n">raw_cursor</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">statement</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execution_args</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">statement</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_execution</span><span class="p">(</span><span class="n">raw_cursor</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">statement</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">raw_cursor</span></div>

    <span class="k">def</span> <span class="nf">_execution_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">statement</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the appropriate statement execution arguments.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_database</span><span class="p">(</span><span class="n">params</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">statement</span><span class="p">,)</span>
        <span class="k">return</span> <span class="n">args</span>

    <span class="k">def</span> <span class="nf">_run_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_cursor</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">statement</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Complete the statement execution, along with result reports.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_disconnect</span><span class="p">(</span><span class="n">raw_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_disconnect</span><span class="p">(</span>
                <span class="n">trace</span><span class="p">,</span> <span class="s2">&quot;connection_raw_execute_error&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">raw_cursor</span><span class="p">,</span>
                <span class="n">statement</span><span class="p">,</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">(),</span> <span class="n">error</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_disconnect</span><span class="p">(</span>
                <span class="n">trace</span><span class="p">,</span> <span class="s2">&quot;connection_raw_execute_success&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">raw_cursor</span><span class="p">,</span>
                <span class="n">statement</span><span class="p">,</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">())</span>

    <span class="k">def</span> <span class="nf">_prepare_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_cursor</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">statement</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare the statement execution to be run.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_disconnect</span><span class="p">(</span>
                <span class="n">trace</span><span class="p">,</span> <span class="s2">&quot;connection_raw_execute&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">raw_cursor</span><span class="p">,</span>
                <span class="n">statement</span><span class="p">,</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_disconnect</span><span class="p">(</span>
                <span class="n">trace</span><span class="p">,</span> <span class="s2">&quot;connection_raw_execute_error&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">raw_cursor</span><span class="p">,</span>
                <span class="n">statement</span><span class="p">,</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">(),</span> <span class="n">error</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_ensure_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ensure that we are connected to the database.</span>

<span class="sd">        If the connection is marked as dead, or if we can&#39;t reconnect,</span>
<span class="sd">        then raise DisconnectionError.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocked</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConnectionBlockedError</span><span class="p">(</span><span class="s2">&quot;Access to connection is blocked&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">STATE_CONNECTED</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">STATE_DISCONNECTED</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DisconnectionError</span><span class="p">(</span><span class="s2">&quot;Already disconnected&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">STATE_RECONNECT</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raw_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_database</span><span class="o">.</span><span class="n">raw_connect</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">STATE_DISCONNECTED</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raw_connection</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">raise</span> <span class="n">DisconnectionError</span><span class="p">(</span><span class="n">ustr</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">STATE_CONNECTED</span>

<div class="viewcode-block" id="Connection.is_disconnection_error"><a class="viewcode-back" href="../../databases.html#storm.database.Connection.is_disconnection_error">[docs]</a>    <span class="k">def</span> <span class="nf">is_disconnection_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">extra_disconnection_errors</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;Check whether an exception represents a database disconnection.</span>

<span class="sd">        This should be overridden by backends to detect whichever</span>
<span class="sd">        exception values are used to represent this condition.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">_raw_xid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a raw xid from the given high-level L{Xid} object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_connection</span><span class="o">.</span><span class="n">xid</span><span class="p">(</span><span class="n">xid</span><span class="o">.</span><span class="n">format_id</span><span class="p">,</span>
                                        <span class="n">xid</span><span class="o">.</span><span class="n">global_transaction_id</span><span class="p">,</span>
                                        <span class="n">xid</span><span class="o">.</span><span class="n">branch_qualifier</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the given function, checking for database disconnections.&quot;&quot;&quot;</span>
        <span class="c1"># Allow the caller to specify additional exception types that</span>
        <span class="c1"># should be treated as possible disconnection errors.</span>
        <span class="n">extra_disconnection_errors</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
            <span class="s1">&#39;extra_disconnection_errors&#39;</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_disconnection_error</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">extra_disconnection_errors</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">STATE_DISCONNECTED</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raw_connection</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">raise</span> <span class="n">DisconnectionError</span><span class="p">(</span><span class="n">ustr</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

<div class="viewcode-block" id="Connection.preset_primary_key"><a class="viewcode-back" href="../../databases.html#storm.database.Connection.preset_primary_key">[docs]</a>    <span class="k">def</span> <span class="nf">preset_primary_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primary_columns</span><span class="p">,</span> <span class="n">primary_variables</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process primary variables before an insert happens.</span>

<span class="sd">        This method may be overwritten by backends to implement custom</span>
<span class="sd">        changes in primary variables before an insert happens.</span>
<span class="sd">        &quot;&quot;&quot;</span></div></div>


<div class="viewcode-block" id="Database"><a class="viewcode-back" href="../../databases.html#storm.database.Database">[docs]</a><span class="k">class</span> <span class="nc">Database</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A database that can be connected to.</span>

<span class="sd">    This should be subclassed for individual database backends.</span>

<span class="sd">    @cvar connection_factory: A callable which will take this database</span>
<span class="sd">        and should return an instance of L{Connection}.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">connection_factory</span> <span class="o">=</span> <span class="n">Connection</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span> <span class="o">=</span> <span class="n">uri</span>

<div class="viewcode-block" id="Database.get_uri"><a class="viewcode-back" href="../../databases.html#storm.database.Database.get_uri">[docs]</a>    <span class="k">def</span> <span class="nf">get_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the URI object this database was created with.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span></div>

<div class="viewcode-block" id="Database.connect"><a class="viewcode-back" href="../../databases.html#storm.database.Database.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a connection to the database.</span>

<span class="sd">        It calls C{self.connection_factory} to allow for ease of</span>
<span class="sd">        customization.</span>

<span class="sd">        @param event: The event system to broadcast messages with. If</span>
<span class="sd">            not specified, then no events will be broadcast.</span>

<span class="sd">        @return: An instance of L{Connection}.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_factory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span></div>

<div class="viewcode-block" id="Database.raw_connect"><a class="viewcode-back" href="../../databases.html#storm.database.Database.raw_connect">[docs]</a>    <span class="k">def</span> <span class="nf">raw_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a raw database connection.</span>

<span class="sd">        This is used by L{Connection} objects to connect to the</span>
<span class="sd">        database.  It should be overriden in subclasses to do any</span>
<span class="sd">        database-specific connection setup.</span>

<span class="sd">        @return: A DB-API connection object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>


<div class="viewcode-block" id="convert_param_marks"><a class="viewcode-back" href="../../databases.html#storm.database.convert_param_marks">[docs]</a><span class="k">def</span> <span class="nf">convert_param_marks</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">from_param_mark</span><span class="p">,</span> <span class="n">to_param_mark</span><span class="p">):</span>
    <span class="c1"># TODO: Add support for $foo$bar$foo$ literals.</span>
    <span class="k">if</span> <span class="n">from_param_mark</span> <span class="o">==</span> <span class="n">to_param_mark</span> <span class="ow">or</span> <span class="n">from_param_mark</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">statement</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">statement</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iter_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">tokens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">from_param_mark</span><span class="p">,</span> <span class="n">to_param_mark</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;&#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span></div>


<span class="n">_database_schemes</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="register_scheme"><a class="viewcode-back" href="../../databases.html#storm.database.register_scheme">[docs]</a><span class="k">def</span> <span class="nf">register_scheme</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">factory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register a handler for a new database URI scheme.</span>

<span class="sd">    @param scheme: the database URI scheme</span>
<span class="sd">    @param factory: a function taking a URI instance and returning a database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_database_schemes</span><span class="p">[</span><span class="n">scheme</span><span class="p">]</span> <span class="o">=</span> <span class="n">factory</span></div>


<div class="viewcode-block" id="create_database"><a class="viewcode-back" href="../../databases.html#storm.database.create_database">[docs]</a><span class="k">def</span> <span class="nf">create_database</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a database instance.</span>

<span class="sd">    @param uri: An URI instance, or a string describing the URI. Some examples:</span>

<span class="sd">        - ``sqlite:`` An in memory sqlite database.</span>
<span class="sd">        - ``sqlite:example.db`` A SQLite database called example.db</span>
<span class="sd">        - ``postgres:test`` The database &#39;test&#39; from the local postgres server.</span>
<span class="sd">        - ``postgres://user:password@host/test`` The database test on machine host</span>
<span class="sd">          with supplied user credentials, using postgres.</span>
<span class="sd">        - ``anything:...`` Where &#39;anything&#39; has previously been registered</span>
<span class="sd">          with L{register_scheme}.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="n">URI</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">in</span> <span class="n">_database_schemes</span><span class="p">:</span>
        <span class="n">factory</span> <span class="o">=</span> <span class="n">_database_schemes</span><span class="p">[</span><span class="n">uri</span><span class="o">.</span><span class="n">scheme</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.databases.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">storm</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">scheme</span><span class="p">))</span>
        <span class="n">factory</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">create_from_uri</span>
    <span class="k">return</span> <span class="n">factory</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span></div>

<span class="c1"># Deal with circular import.</span>
<span class="kn">from</span> <span class="nn">storm.tracer</span> <span class="k">import</span> <span class="n">trace</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Storm</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../basic-usage.html">Basic usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infoheritance.html">Infoheritance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../store.html">Store</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../columns.html">Columns and types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../expr.html">Expressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../databases.html">Databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../events.html">Hooks and events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../miscellaneous.html">Miscellaneous libraries</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Gustavo Niemeyer.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>