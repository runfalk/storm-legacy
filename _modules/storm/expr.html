
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>storm.expr &#8212; Storm  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for storm.expr</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Copyright (c) 2006, 2007 Canonical</span>
<span class="c1">#</span>
<span class="c1"># Written by Gustavo Niemeyer &lt;gustavo@niemeyer.net&gt;</span>
<span class="c1">#</span>
<span class="c1"># This file is part of Storm Object Relational Mapper.</span>
<span class="c1">#</span>
<span class="c1"># Storm is free software; you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Lesser General Public License as</span>
<span class="c1"># published by the Free Software Foundation; either version 2.1 of</span>
<span class="c1"># the License, or (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># Storm is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Lesser General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Lesser General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="kn">from</span> <span class="nn">decimal</span> <span class="k">import</span> <span class="n">Decimal</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">weakref</span> <span class="k">import</span> <span class="n">WeakKeyDictionary</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">storm.compat</span> <span class="k">import</span> <span class="n">bstr</span><span class="p">,</span> <span class="n">is_python2</span><span class="p">,</span> <span class="n">long_int</span><span class="p">,</span> <span class="n">ustr</span>
<span class="kn">from</span> <span class="nn">storm.exceptions</span> <span class="k">import</span> <span class="n">CompileError</span><span class="p">,</span> <span class="n">NoTableError</span><span class="p">,</span> <span class="n">ExprError</span>
<span class="kn">from</span> <span class="nn">storm.variables</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Variable</span><span class="p">,</span> <span class="n">RawStrVariable</span><span class="p">,</span> <span class="n">UnicodeVariable</span><span class="p">,</span> <span class="n">LazyValue</span><span class="p">,</span>
    <span class="n">DateTimeVariable</span><span class="p">,</span> <span class="n">DateVariable</span><span class="p">,</span> <span class="n">TimeVariable</span><span class="p">,</span> <span class="n">TimeDeltaVariable</span><span class="p">,</span>
    <span class="n">BoolVariable</span><span class="p">,</span> <span class="n">IntVariable</span><span class="p">,</span> <span class="n">FloatVariable</span><span class="p">,</span> <span class="n">DecimalVariable</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">storm</span> <span class="k">import</span> <span class="n">Undef</span><span class="p">,</span> <span class="n">has_cextensions</span>


<span class="c1"># --------------------------------------------------------------------</span>
<span class="c1"># Basic compiler infrastructure</span>

<span class="k">def</span> <span class="nf">_when</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check Compile.when.  Defined here to ease the work of cextensions.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
        <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_local_dispatch_table</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_cache</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">method</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="k">class</span> <span class="nc">Compile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compiler based on the concept of generic functions.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_dispatch_table</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_precedence</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_reserved_words</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_table</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_precedence</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_words</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_children</span> <span class="o">=</span> <span class="n">WeakKeyDictionary</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">_parents</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">_children</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_cache</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parents</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">_local_dispatch_table</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_precedence</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">_local_precedence</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_words</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">_local_reserved_words</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_dispatch_table</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_precedence</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_precedence</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_words</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_reserved_words</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_children</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">_update_cache</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">when</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">types</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Decorator to include a type handler in this compiler.</span>

<span class="sd">        Use this as:</span>

<span class="sd">            &gt;&gt;&gt; @compile.when(TypeA, TypeB)</span>
<span class="sd">            &gt;&gt;&gt; def compile_type_a_or_b(compile, expr, state):</span>
<span class="sd">            &gt;&gt;&gt;     ...</span>
<span class="sd">            &gt;&gt;&gt;     return &quot;THE COMPILED SQL STATEMENT&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_when</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">types</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_reserved_words</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">words</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Include words to be considered reserved and thus escaped.</span>

<span class="sd">        Reserved words are escaped during compilation when they&#39;re</span>
<span class="sd">        seen in a SQLToken expression.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_reserved_words</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span>
                                          <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_cache</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">remove_reserved_words</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">words</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_reserved_words</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="kc">None</span><span class="p">)</span>
                                          <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_cache</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">is_reserved_word</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_words</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">create_child</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new instance of L{Compile} which inherits from this one.</span>

<span class="sd">        This is most commonly used to customize a compiler for</span>
<span class="sd">        database-specific compilation strategies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_precedence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_precedence</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">MAX_PRECEDENCE</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_precedence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">precedence</span><span class="p">,</span> <span class="o">*</span><span class="n">types</span><span class="p">):</span>
        <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_local_precedence</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">precedence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_cache</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compile_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">outer_precedence</span><span class="p">):</span>
        <span class="c1"># FASTPATH This method is part of the fast path.  Be careful when</span>
        <span class="c1">#          changing it (try to profile any changes).</span>

        <span class="bp">cls</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">dispatch_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_table</span>
        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">dispatch_table</span><span class="p">:</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">dispatch_table</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mro_cls</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
                <span class="c1"># First iteration will always fail because we&#39;ve already</span>
                <span class="c1"># tested that the class itself isn&#39;t in the dispatch table.</span>
                <span class="k">if</span> <span class="n">mro_cls</span> <span class="ow">in</span> <span class="n">dispatch_table</span><span class="p">:</span>
                    <span class="n">handler</span> <span class="o">=</span> <span class="n">dispatch_table</span><span class="p">[</span><span class="n">mro_cls</span><span class="p">]</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CompileError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to compile type </span><span class="si">%r</span><span class="s2"> of </span><span class="si">%r</span><span class="s2">&quot;</span>
                                   <span class="o">%</span> <span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">expr</span><span class="p">))</span>
        <span class="n">inner_precedence</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">precedence</span> <span class="o">=</span> \
                           <span class="bp">self</span><span class="o">.</span><span class="n">_precedence</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">MAX_PRECEDENCE</span><span class="p">)</span>
        <span class="n">statement</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inner_precedence</span> <span class="o">&lt;</span> <span class="n">outer_precedence</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">statement</span>
        <span class="k">return</span> <span class="n">statement</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="sa">u</span><span class="s2">&quot;, &quot;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compile the given expression into a SQL statement.</span>

<span class="sd">        @param expr: The expression to compile.</span>
<span class="sd">        @param state: An instance of State, or None, in which case it&#39;s</span>
<span class="sd">            created internally (and thus can&#39;t be accessed).</span>
<span class="sd">        @param join: The string token to use to put between</span>
<span class="sd">            subexpressions. Defaults to &quot;, &quot;.</span>
<span class="sd">        @param raw: If true, any string or unicode expression or</span>
<span class="sd">            subexpression will not be further compiled.</span>
<span class="sd">        @param token: If true, any string or unicode expression will</span>
<span class="sd">            be considered as a SQLToken, and quoted properly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># FASTPATH This method is part of the fast path.  Be careful when</span>
        <span class="c1">#          changing it (try to profile any changes).</span>

        <span class="n">expr_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">expr_type</span> <span class="ow">is</span> <span class="n">SQLRaw</span> <span class="ow">or</span>
            <span class="n">raw</span> <span class="ow">and</span> <span class="p">(</span><span class="n">expr_type</span> <span class="ow">is</span> <span class="n">bstr</span> <span class="ow">or</span> <span class="n">expr_type</span> <span class="ow">is</span> <span class="n">ustr</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">expr</span>

        <span class="k">if</span> <span class="n">token</span> <span class="ow">and</span> <span class="p">(</span><span class="n">expr_type</span> <span class="ow">is</span> <span class="n">bstr</span> <span class="ow">or</span> <span class="n">expr_type</span> <span class="ow">is</span> <span class="n">ustr</span><span class="p">):</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">SQLToken</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>

        <span class="n">outer_precedence</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">precedence</span>
        <span class="k">if</span> <span class="n">expr_type</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="n">expr_type</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">compiled</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">subexpr</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">:</span>
                <span class="n">subexpr_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">subexpr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">subexpr_type</span> <span class="ow">is</span> <span class="n">SQLRaw</span> <span class="ow">or</span> <span class="n">raw</span> <span class="ow">and</span> <span class="p">(</span><span class="n">subexpr_type</span> <span class="ow">is</span> <span class="n">bstr</span> <span class="ow">or</span>
                                                      <span class="n">subexpr_type</span> <span class="ow">is</span> <span class="n">ustr</span><span class="p">):</span>
                    <span class="n">statement</span> <span class="o">=</span> <span class="n">subexpr</span>
                <span class="k">elif</span> <span class="n">subexpr_type</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="n">subexpr_type</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">state</span><span class="o">.</span><span class="n">precedence</span> <span class="o">=</span> <span class="n">outer_precedence</span>
                    <span class="n">statement</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">subexpr</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">raw</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">token</span> <span class="ow">and</span> <span class="p">(</span><span class="n">subexpr_type</span> <span class="ow">is</span> <span class="n">ustr</span> <span class="ow">or</span>
                                  <span class="n">subexpr_type</span> <span class="ow">is</span> <span class="n">bstr</span><span class="p">):</span>
                        <span class="n">subexpr</span> <span class="o">=</span> <span class="n">SQLToken</span><span class="p">(</span><span class="n">subexpr</span><span class="p">)</span>
                    <span class="n">statement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_single</span><span class="p">(</span><span class="n">subexpr</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>
                                                     <span class="n">outer_precedence</span><span class="p">)</span>
                <span class="n">compiled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
            <span class="n">statement</span> <span class="o">=</span> <span class="n">join</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">compiled</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">statement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_single</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">outer_precedence</span><span class="p">)</span>
        <span class="n">state</span><span class="o">.</span><span class="n">precedence</span> <span class="o">=</span> <span class="n">outer_precedence</span>

        <span class="k">return</span> <span class="n">statement</span>


<span class="k">if</span> <span class="n">has_cextensions</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">storm.cextensions</span> <span class="k">import</span> <span class="n">Compile</span>


<div class="viewcode-block" id="CompilePython"><a class="viewcode-back" href="../../expr.html#storm.expr.CompilePython">[docs]</a><span class="k">class</span> <span class="nc">CompilePython</span><span class="p">(</span><span class="n">Compile</span><span class="p">):</span>

<div class="viewcode-block" id="CompilePython.get_matcher"><a class="viewcode-back" href="../../expr.html#storm.expr.CompilePython.get_matcher">[docs]</a>    <span class="k">def</span> <span class="nf">get_matcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;def closure(parameters, bool):</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;    [</span><span class="si">%s</span><span class="s2">] = parameters</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;    def match(get_column):</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;        return bool(</span><span class="si">%s</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;    return match&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="p">))),</span>
                 <span class="n">source</span><span class="p">))</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">namespace</span><span class="p">[</span><span class="s1">&#39;closure&#39;</span><span class="p">](</span><span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="State"><a class="viewcode-back" href="../../expr.html#storm.expr.State">[docs]</a><span class="k">class</span> <span class="nc">State</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;All the data necessary during compilation of an expression.</span>

<span class="sd">    @ivar aliases: Dict of L{Column} instances to L{Alias} instances,</span>
<span class="sd">        specifying how columns should be compiled as aliases in very</span>
<span class="sd">        specific situations.  This is typically used to work around</span>
<span class="sd">        strange deficiencies in various databases.</span>

<span class="sd">    @ivar auto_tables: The list of all implicitly-used tables.  e.g.,</span>
<span class="sd">        in store.find(Foo, Foo.attr==Bar.id), the tables of Bar and</span>
<span class="sd">        Foo are implicitly used because columns in them are</span>
<span class="sd">        referenced. This is used when building tables.</span>

<span class="sd">    @ivar join_tables: If not None, when Join expressions are</span>
<span class="sd">        compiled, tables seen will be added to this set. This acts as</span>
<span class="sd">        a blacklist against auto_tables when compiling Joins, because</span>
<span class="sd">        the generated statements should not refer to the table twice.</span>

<span class="sd">    @ivar context: an instance of L{Context}, specifying the context</span>
<span class="sd">        of the expression currently being compiled.</span>

<span class="sd">    @ivar precedence: Current precedence, automatically set and restored</span>
<span class="sd">        by the compiler. If an inner precedence is lower than an outer</span>
<span class="sd">        precedence, parenthesis around the inner expression are</span>
<span class="sd">        automatically emitted.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precedence</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_tables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join_tables</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="State.push"><a class="viewcode-back" href="../../expr.html#storm.expr.State.push">[docs]</a>    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new_value</span><span class="o">=</span><span class="n">Undef</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set an attribute in a way that can later be reverted with L{pop}.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">old_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">attr</span><span class="p">,</span> <span class="n">old_value</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">new_value</span> <span class="ow">is</span> <span class="n">Undef</span><span class="p">:</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">old_value</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">old_value</span></div>

<div class="viewcode-block" id="State.pop"><a class="viewcode-back" href="../../expr.html#storm.expr.State.pop">[docs]</a>    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Revert the topmost L{push}.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span></div></div>


<span class="nb">compile</span> <span class="o">=</span> <span class="n">Compile</span><span class="p">()</span>
<span class="n">compile_python</span> <span class="o">=</span> <span class="n">CompilePython</span><span class="p">()</span>


<span class="c1"># --------------------------------------------------------------------</span>
<span class="c1"># Expression contexts</span>

<div class="viewcode-block" id="Context"><a class="viewcode-back" href="../../expr.html#storm.expr.Context">[docs]</a><span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An object used to specify the nature of expected SQL expressions</span>
<span class="sd">    being compiled in a given context.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span></div>


<span class="n">TABLE</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="s2">&quot;TABLE&quot;</span><span class="p">)</span>
<span class="n">EXPR</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="s2">&quot;EXPR&quot;</span><span class="p">)</span>
<span class="n">COLUMN</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="s2">&quot;COLUMN&quot;</span><span class="p">)</span>
<span class="n">COLUMN_PREFIX</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="s2">&quot;COLUMN_PREFIX&quot;</span><span class="p">)</span>
<span class="n">COLUMN_NAME</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="s2">&quot;COLUMN_NAME&quot;</span><span class="p">)</span>
<span class="n">SELECT</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="s2">&quot;SELECT&quot;</span><span class="p">)</span>


<span class="c1"># --------------------------------------------------------------------</span>
<span class="c1"># Builtin type support</span>

<div class="viewcode-block" id="compile_str"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_str">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">bstr</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_str</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RawStrVariable</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">&quot;?&quot;</span></div>

<div class="viewcode-block" id="compile_unicode"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_unicode">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">ustr</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_unicode</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UnicodeVariable</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">&quot;?&quot;</span></div>

<div class="viewcode-block" id="compile_int"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_int">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">long_int</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_int</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">IntVariable</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">&quot;?&quot;</span></div>

<div class="viewcode-block" id="compile_float"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_float">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_float</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FloatVariable</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">&quot;?&quot;</span></div>

<div class="viewcode-block" id="compile_decimal"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_decimal">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Decimal</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_decimal</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DecimalVariable</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">&quot;?&quot;</span></div>

<div class="viewcode-block" id="compile_bool"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_bool">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_bool</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BoolVariable</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">&quot;?&quot;</span></div>

<div class="viewcode-block" id="compile_datetime"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_datetime">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">datetime</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_datetime</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DateTimeVariable</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">&quot;?&quot;</span></div>

<div class="viewcode-block" id="compile_date"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_date">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_date</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DateVariable</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">&quot;?&quot;</span></div>

<div class="viewcode-block" id="compile_time"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_time">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_time</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TimeVariable</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">&quot;?&quot;</span></div>

<div class="viewcode-block" id="compile_timedelta"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_timedelta">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">timedelta</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_timedelta</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TimeDeltaVariable</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">&quot;?&quot;</span></div>

<div class="viewcode-block" id="compile_none"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_none">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">compile_none</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;NULL&quot;</span></div>


<div class="viewcode-block" id="compile_python_builtin"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_python_builtin">[docs]</a><span class="nd">@compile_python</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">bstr</span><span class="p">,</span> <span class="n">ustr</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">long_int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">compile_python_builtin</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span></div>


<div class="viewcode-block" id="compile_python_bool_and_dates"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_python_bool_and_dates">[docs]</a><span class="nd">@compile_python</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_python_bool_and_dates</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">index</span></div>


<div class="viewcode-block" id="compile_variable"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_variable">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Variable</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_variable</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;?&quot;</span></div>

<div class="viewcode-block" id="compile_python_variable"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_python_variable">[docs]</a><span class="nd">@compile_python</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Variable</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_python_variable</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
    <span class="k">return</span> <span class="s2">&quot;_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">index</span></div>


<span class="c1"># --------------------------------------------------------------------</span>
<span class="c1"># Base classes for expressions</span>

<span class="n">MAX_PRECEDENCE</span> <span class="o">=</span> <span class="mi">1000</span>

<div class="viewcode-block" id="Expr"><a class="viewcode-back" href="../../expr.html#storm.expr.Expr">[docs]</a><span class="k">class</span> <span class="nc">Expr</span><span class="p">(</span><span class="n">LazyValue</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span></div>

<div class="viewcode-block" id="compile_python_unsupported"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_python_unsupported">[docs]</a><span class="nd">@compile_python</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Expr</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_python_unsupported</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">CompileError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t compile python expressions with </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span></div>


<span class="c1"># A translation table that can escape a unicode string for use in a</span>
<span class="c1"># Like() expression that uses &quot;!&quot; as the escape character.</span>
<span class="n">like_escape</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nb">ord</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;!&quot;</span><span class="p">):</span> <span class="sa">u</span><span class="s2">&quot;!!&quot;</span><span class="p">,</span>
    <span class="nb">ord</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;_&quot;</span><span class="p">):</span> <span class="sa">u</span><span class="s2">&quot;!_&quot;</span><span class="p">,</span>
    <span class="nb">ord</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;%&quot;</span><span class="p">):</span> <span class="sa">u</span><span class="s2">&quot;!%&quot;</span>
    <span class="p">}</span>


<div class="viewcode-block" id="Comparable"><a class="viewcode-back" href="../../expr.html#storm.expr.Comparable">[docs]</a><span class="k">class</span> <span class="nc">Comparable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;variable_factory&quot;</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)(</span><span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;variable_factory&quot;</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)(</span><span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Ne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;variable_factory&quot;</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)(</span><span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Gt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;variable_factory&quot;</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)(</span><span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Ge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;variable_factory&quot;</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)(</span><span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Lt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;variable_factory&quot;</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)(</span><span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Le</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__rshift__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;variable_factory&quot;</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)(</span><span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">RShift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__lshift__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;variable_factory&quot;</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)(</span><span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">LShift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__and__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;variable_factory&quot;</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)(</span><span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">And</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;variable_factory&quot;</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)(</span><span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Or</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;variable_factory&quot;</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)(</span><span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;variable_factory&quot;</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)(</span><span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;variable_factory&quot;</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)(</span><span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Mul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="c1"># TODO: This should technically be floordiv</span>
    <span class="k">def</span> <span class="nf">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;variable_factory&quot;</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)(</span><span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Div</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="c1"># Python 2 compatibility</span>
    <span class="n">__div__</span> <span class="o">=</span> <span class="fm">__truediv__</span>

    <span class="k">def</span> <span class="nf">__mod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;variable_factory&quot;</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)(</span><span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Mod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Neg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Comparable.is_in"><a class="viewcode-back" href="../../expr.html#storm.expr.Comparable.is_in">[docs]</a>    <span class="k">def</span> <span class="nf">is_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">others</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">others</span><span class="p">,</span> <span class="n">Expr</span><span class="p">):</span>
            <span class="n">others</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">others</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">others</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">variable_factory</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;variable_factory&quot;</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">other</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">others</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)):</span>
                    <span class="n">others</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable_factory</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">In</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">others</span><span class="p">)</span></div>

<div class="viewcode-block" id="Comparable.like"><a class="viewcode-back" href="../../expr.html#storm.expr.Comparable.like">[docs]</a>    <span class="k">def</span> <span class="nf">like</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">escape</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span> <span class="n">case_sensitive</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;variable_factory&quot;</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)(</span><span class="n">value</span><span class="o">=</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Like</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">escape</span><span class="p">,</span> <span class="n">case_sensitive</span><span class="p">)</span></div>

<div class="viewcode-block" id="Comparable.lower"><a class="viewcode-back" href="../../expr.html#storm.expr.Comparable.lower">[docs]</a>    <span class="k">def</span> <span class="nf">lower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Lower</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Comparable.upper"><a class="viewcode-back" href="../../expr.html#storm.expr.Comparable.upper">[docs]</a>    <span class="k">def</span> <span class="nf">upper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Upper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Comparable.startswith"><a class="viewcode-back" href="../../expr.html#storm.expr.Comparable.startswith">[docs]</a>    <span class="k">def</span> <span class="nf">startswith</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ustr</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ExprError</span><span class="p">(</span><span class="s2">&quot;Expected unicode argument, got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">like_escape</span><span class="p">)</span> <span class="o">+</span> <span class="sa">u</span><span class="s2">&quot;%&quot;</span>
        <span class="k">return</span> <span class="n">Like</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Comparable.endswith"><a class="viewcode-back" href="../../expr.html#storm.expr.Comparable.endswith">[docs]</a>    <span class="k">def</span> <span class="nf">endswith</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suffix</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">ustr</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ExprError</span><span class="p">(</span><span class="s2">&quot;Expected unicode argument, got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">suffix</span><span class="p">))</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;%&quot;</span> <span class="o">+</span> <span class="n">suffix</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">like_escape</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Like</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Comparable.contains_string"><a class="viewcode-back" href="../../expr.html#storm.expr.Comparable.contains_string">[docs]</a>    <span class="k">def</span> <span class="nf">contains_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">substring</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">substring</span><span class="p">,</span> <span class="n">ustr</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ExprError</span><span class="p">(</span><span class="s2">&quot;Expected unicode argument, got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">substring</span><span class="p">))</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;%&quot;</span> <span class="o">+</span> <span class="n">substring</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">like_escape</span><span class="p">)</span> <span class="o">+</span> <span class="sa">u</span><span class="s2">&quot;%&quot;</span>
        <span class="k">return</span> <span class="n">Like</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;!&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ComparableExpr"><a class="viewcode-back" href="../../expr.html#storm.expr.ComparableExpr">[docs]</a><span class="k">class</span> <span class="nc">ComparableExpr</span><span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Comparable</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span></div>

<div class="viewcode-block" id="BinaryExpr"><a class="viewcode-back" href="../../expr.html#storm.expr.BinaryExpr">[docs]</a><span class="k">class</span> <span class="nc">BinaryExpr</span><span class="p">(</span><span class="n">ComparableExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;expr1&quot;</span><span class="p">,</span> <span class="s2">&quot;expr2&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr1</span><span class="p">,</span> <span class="n">expr2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expr1</span> <span class="o">=</span> <span class="n">expr1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expr2</span> <span class="o">=</span> <span class="n">expr2</span></div>

<div class="viewcode-block" id="CompoundExpr"><a class="viewcode-back" href="../../expr.html#storm.expr.CompoundExpr">[docs]</a><span class="k">class</span> <span class="nc">CompoundExpr</span><span class="p">(</span><span class="n">ComparableExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;exprs&quot;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exprs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span> <span class="o">=</span> <span class="n">exprs</span></div>


<span class="c1"># --------------------------------------------------------------------</span>
<span class="c1"># Statement expressions</span>

<div class="viewcode-block" id="has_tables"><a class="viewcode-back" href="../../expr.html#storm.expr.has_tables">[docs]</a><span class="k">def</span> <span class="nf">has_tables</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">tables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span> <span class="ow">or</span>
            <span class="n">expr</span><span class="o">.</span><span class="n">default_tables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span> <span class="ow">or</span>
            <span class="n">state</span><span class="o">.</span><span class="n">auto_tables</span><span class="p">)</span></div>

<div class="viewcode-block" id="build_tables"><a class="viewcode-back" href="../../expr.html#storm.expr.build_tables">[docs]</a><span class="k">def</span> <span class="nf">build_tables</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">default_tables</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compile provided tables.</span>

<span class="sd">    Tables will be built from either C{tables}, C{state.auto_tables}, or</span>
<span class="sd">    C{default_tables}.  If C{tables} is not C{Undef}, it will be used. If</span>
<span class="sd">    C{tables} is C{Undef} and C{state.auto_tables} is available, that&#39;s used</span>
<span class="sd">    instead. If neither C{tables} nor C{state.auto_tables} are available,</span>
<span class="sd">    C{default_tables} is tried as a last resort. If none of them are available,</span>
<span class="sd">    C{NoTableError} is raised.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tables</span> <span class="ow">is</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">auto_tables</span><span class="p">:</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">auto_tables</span>
        <span class="k">elif</span> <span class="n">default_tables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="n">default_tables</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># If we have no elements, it&#39;s an error.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tables</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NoTableError</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find any tables&quot;</span><span class="p">)</span>

    <span class="c1"># If it&#39;s a single element, it&#39;s trivial.</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">compile</span><span class="p">(</span><span class="n">tables</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># If we have no joins, it&#39;s trivial as well.</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">JoinExpr</span><span class="p">):</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tables</span> <span class="ow">is</span> <span class="n">state</span><span class="o">.</span><span class="n">auto_tables</span><span class="p">:</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">tables</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">compile</span><span class="p">(</span><span class="n">tables</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Ok, now we have to be careful.</span>

    <span class="c1"># If we&#39;re dealing with auto_tables, we have to take care of</span>
    <span class="c1"># duplicated tables, join ordering, and so on.</span>
    <span class="k">if</span> <span class="n">tables</span> <span class="ow">is</span> <span class="n">state</span><span class="o">.</span><span class="n">auto_tables</span><span class="p">:</span>
        <span class="n">table_stmts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">join_stmts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">half_join_stmts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># push a join_tables onto the state: compile calls below will</span>
        <span class="c1"># populate this set so that we know what tables not to include.</span>
        <span class="n">state</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s2">&quot;join_tables&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
            <span class="n">statement</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">JoinExpr</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">left</span> <span class="ow">is</span> <span class="n">Undef</span><span class="p">:</span>
                    <span class="n">half_join_stmts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">join_stmts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">table_stmts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>

        <span class="c1"># Remove tables that were seen in join statements.</span>
        <span class="n">table_stmts</span> <span class="o">-=</span> <span class="n">state</span><span class="o">.</span><span class="n">join_tables</span>

        <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">table_stmts</span><span class="p">)</span><span class="o">+</span><span class="nb">sorted</span><span class="p">(</span><span class="n">join_stmts</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">half_join_stmts</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">half_join_stmts</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="c1"># Otherwise, it&#39;s just a matter of putting it together.</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">JoinExpr</span><span class="p">)</span> <span class="ow">and</span> <span class="n">elem</span><span class="o">.</span><span class="n">left</span> <span class="ow">is</span> <span class="n">Undef</span><span class="p">:</span> <span class="c1">#half-join</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>


<div class="viewcode-block" id="Select"><a class="viewcode-back" href="../../expr.html#storm.expr.Select">[docs]</a><span class="k">class</span> <span class="nc">Select</span><span class="p">(</span><span class="n">Expr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="s2">&quot;where&quot;</span><span class="p">,</span> <span class="s2">&quot;tables&quot;</span><span class="p">,</span> <span class="s2">&quot;default_tables&quot;</span><span class="p">,</span> <span class="s2">&quot;order_by&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;group_by&quot;</span><span class="p">,</span> <span class="s2">&quot;limit&quot;</span><span class="p">,</span> <span class="s2">&quot;offset&quot;</span><span class="p">,</span> <span class="s2">&quot;distinct&quot;</span><span class="p">,</span> <span class="s2">&quot;having&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span>
                 <span class="n">tables</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span> <span class="n">default_tables</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span>
                 <span class="n">order_by</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span> <span class="n">group_by</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span>
                 <span class="n">limit</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">having</span><span class="o">=</span><span class="n">Undef</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">where</span> <span class="o">=</span> <span class="n">where</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="n">tables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_tables</span> <span class="o">=</span> <span class="n">default_tables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span> <span class="o">=</span> <span class="n">order_by</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_by</span> <span class="o">=</span> <span class="n">group_by</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distinct</span> <span class="o">=</span> <span class="n">distinct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">having</span> <span class="o">=</span> <span class="n">having</span></div>

<div class="viewcode-block" id="compile_select"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_select">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Select</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_select</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SELECT &quot;</span><span class="p">]</span>
    <span class="n">state</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s2">&quot;auto_tables&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">state</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="n">COLUMN</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">distinct</span><span class="p">:</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;DISTINCT &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">select</span><span class="o">.</span><span class="n">distinct</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;ON (</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="nb">compile</span><span class="p">(</span><span class="n">select</span><span class="o">.</span><span class="n">distinct</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">select</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>
    <span class="n">tables_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
    <span class="n">parameters_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">EXPR</span>
    <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; WHERE &quot;</span><span class="p">)</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">select</span><span class="o">.</span><span class="n">where</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">group_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; GROUP BY &quot;</span><span class="p">)</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">select</span><span class="o">.</span><span class="n">group_by</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">having</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; HAVING &quot;</span><span class="p">)</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">select</span><span class="o">.</span><span class="n">having</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">order_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; ORDER BY &quot;</span><span class="p">)</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">select</span><span class="o">.</span><span class="n">order_by</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; LIMIT </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">select</span><span class="o">.</span><span class="n">limit</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">select</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">has_tables</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">select</span><span class="p">):</span>
        <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">TABLE</span>
        <span class="n">state</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s2">&quot;parameters&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tables_pos</span><span class="p">,</span> <span class="s2">&quot; FROM &quot;</span><span class="p">)</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tables_pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">build_tables</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">select</span><span class="o">.</span><span class="n">tables</span><span class="p">,</span>
                                                 <span class="n">select</span><span class="o">.</span><span class="n">default_tables</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">parameters_pos</span><span class="p">:</span><span class="n">parameters_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span>
    <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span></div>


<div class="viewcode-block" id="Insert"><a class="viewcode-back" href="../../expr.html#storm.expr.Insert">[docs]</a><span class="k">class</span> <span class="nc">Insert</span><span class="p">(</span><span class="n">Expr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Expression representing an insert statement.</span>

<span class="sd">    @ivar map: Dictionary mapping columns to values, or a sequence of columns</span>
<span class="sd">        for a bulk insert.</span>
<span class="sd">    @ivar table: Table where the row should be inserted.</span>
<span class="sd">    @ivar default_table: Table to use if no table is explicitly provided, and</span>
<span class="sd">        no tables may be inferred from provided columns.</span>
<span class="sd">    @ivar primary_columns: Tuple of columns forming the primary key of the</span>
<span class="sd">        table where the row will be inserted.  This is a hint used by backends</span>
<span class="sd">        to process the insertion of rows.</span>
<span class="sd">    @ivar primary_variables: Tuple of variables with values for the primary</span>
<span class="sd">        key of the table where the row will be inserted.  This is a hint used</span>
<span class="sd">        by backends to process the insertion of rows.</span>
<span class="sd">    @ivar values: Expression or sequence of tuples of values for bulk</span>
<span class="sd">        insertion.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;map&quot;</span><span class="p">,</span> <span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="s2">&quot;default_table&quot;</span><span class="p">,</span> <span class="s2">&quot;primary_columns&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;primary_variables&quot;</span><span class="p">,</span> <span class="s2">&quot;values&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span> <span class="n">default_table</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span>
                 <span class="n">primary_columns</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span> <span class="n">primary_variables</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span>
                 <span class="n">values</span><span class="o">=</span><span class="n">Undef</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="nb">map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_table</span> <span class="o">=</span> <span class="n">default_table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_columns</span> <span class="o">=</span> <span class="n">primary_columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_variables</span> <span class="o">=</span> <span class="n">primary_variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">values</span></div>

<div class="viewcode-block" id="compile_insert"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_insert">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Insert</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_insert</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">insert</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">state</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="n">COLUMN_NAME</span><span class="p">)</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">insert</span><span class="o">.</span><span class="n">map</span><span class="p">),</span> <span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">TABLE</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">build_tables</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">insert</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">insert</span><span class="o">.</span><span class="n">default_table</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">EXPR</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">insert</span><span class="o">.</span><span class="n">values</span>
    <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">insert</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">Expr</span><span class="p">):</span>
        <span class="n">compiled_values</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">compiled_values</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;VALUES (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span>
            <span class="s2">&quot;), (&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">))</span>
    <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;INSERT INTO &quot;</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="s2">&quot; (&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;) &quot;</span><span class="p">,</span> <span class="n">compiled_values</span><span class="p">])</span></div>


<div class="viewcode-block" id="Update"><a class="viewcode-back" href="../../expr.html#storm.expr.Update">[docs]</a><span class="k">class</span> <span class="nc">Update</span><span class="p">(</span><span class="n">Expr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;map&quot;</span><span class="p">,</span> <span class="s2">&quot;where&quot;</span><span class="p">,</span> <span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="s2">&quot;default_table&quot;</span><span class="p">,</span> <span class="s2">&quot;primary_columns&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span> <span class="n">default_table</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span>
                 <span class="n">primary_columns</span><span class="o">=</span><span class="n">Undef</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="nb">map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">where</span> <span class="o">=</span> <span class="n">where</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_table</span> <span class="o">=</span> <span class="n">default_table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_columns</span> <span class="o">=</span> <span class="n">primary_columns</span></div>

<div class="viewcode-block" id="compile_update"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_update">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Update</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_update</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">map</span>
    <span class="n">state</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="n">COLUMN_NAME</span><span class="p">)</span>
    <span class="n">sets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                       <span class="nb">compile</span><span class="p">(</span><span class="nb">map</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">state</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">]</span>
    <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">TABLE</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;UPDATE &quot;</span><span class="p">,</span> <span class="n">build_tables</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">update</span><span class="o">.</span><span class="n">table</span><span class="p">,</span>
                                      <span class="n">update</span><span class="o">.</span><span class="n">default_table</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span>
              <span class="s2">&quot; SET &quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sets</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">EXPR</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; WHERE &quot;</span><span class="p">)</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">where</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span></div>


<div class="viewcode-block" id="Delete"><a class="viewcode-back" href="../../expr.html#storm.expr.Delete">[docs]</a><span class="k">class</span> <span class="nc">Delete</span><span class="p">(</span><span class="n">Expr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;where&quot;</span><span class="p">,</span> <span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="s2">&quot;default_table&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span> <span class="n">default_table</span><span class="o">=</span><span class="n">Undef</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">where</span> <span class="o">=</span> <span class="n">where</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_table</span> <span class="o">=</span> <span class="n">default_table</span></div>

<div class="viewcode-block" id="compile_delete"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_delete">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Delete</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_delete</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">delete</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DELETE FROM &quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">state</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="n">EXPR</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">delete</span><span class="o">.</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; WHERE &quot;</span><span class="p">)</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">delete</span><span class="o">.</span><span class="n">where</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="c1"># Compile later for auto_tables support.</span>
    <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">TABLE</span>
    <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_tables</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">delete</span><span class="o">.</span><span class="n">table</span><span class="p">,</span>
                             <span class="n">delete</span><span class="o">.</span><span class="n">default_table</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span></div>


<span class="c1"># --------------------------------------------------------------------</span>
<span class="c1"># Columns</span>

<div class="viewcode-block" id="Column"><a class="viewcode-back" href="../../expr.html#storm.expr.Column">[docs]</a><span class="k">class</span> <span class="nc">Column</span><span class="p">(</span><span class="n">ComparableExpr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Representation of a column in some table.</span>

<span class="sd">    @ivar name: Column name.</span>
<span class="sd">    @ivar table: Column table (maybe another expression).</span>
<span class="sd">    @ivar primary: Integer representing the primary key position of</span>
<span class="sd">        this column, or 0 if it&#39;s not a primary key. May be provided as</span>
<span class="sd">        a bool.</span>
<span class="sd">    @ivar variable_factory: Factory producing C{Variable} instances typed</span>
<span class="sd">        according to this column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="s2">&quot;primary&quot;</span><span class="p">,</span> <span class="s2">&quot;variable_factory&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;compile_cache&quot;</span><span class="p">,</span> <span class="s2">&quot;compile_id&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span> <span class="n">primary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">variable_factory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">primary</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variable_factory</span> <span class="o">=</span> <span class="n">variable_factory</span> <span class="ow">or</span> <span class="n">Variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compile_cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compile_id</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_python2</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="compile_column"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_column">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Column</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_column</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">auto_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="n">Undef</span> <span class="ow">or</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="ow">is</span> <span class="n">COLUMN_NAME</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">aliases</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># See compile_set_expr().</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">alias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">compile</span><span class="p">(</span><span class="n">alias</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">compile_id</span> <span class="o">!=</span> <span class="nb">id</span><span class="p">(</span><span class="nb">compile</span><span class="p">):</span>
            <span class="n">column</span><span class="o">.</span><span class="n">compile_cache</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">column</span><span class="o">.</span><span class="n">compile_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="nb">compile</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">column</span><span class="o">.</span><span class="n">compile_cache</span>
    <span class="n">state</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="n">COLUMN_PREFIX</span><span class="p">)</span>
    <span class="n">table</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">compile_id</span> <span class="o">!=</span> <span class="nb">id</span><span class="p">(</span><span class="nb">compile</span><span class="p">):</span>
        <span class="n">column</span><span class="o">.</span><span class="n">compile_cache</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">column</span><span class="o">.</span><span class="n">compile_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="nb">compile</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">compile_cache</span><span class="p">)</span></div>

<div class="viewcode-block" id="compile_python_column"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_python_column">[docs]</a><span class="nd">@compile_python</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Column</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_python_column</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;get_column(_</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">index</span></div>


<span class="c1"># --------------------------------------------------------------------</span>
<span class="c1"># Alias expressions</span>

<div class="viewcode-block" id="Alias"><a class="viewcode-back" href="../../expr.html#storm.expr.Alias">[docs]</a><span class="k">class</span> <span class="nc">Alias</span><span class="p">(</span><span class="n">ComparableExpr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A representation of &quot;AS&quot; alias clauses. e.g., SELECT foo AS bar.&quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;expr&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span>

    <span class="n">auto_counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">Undef</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create alias of C{expr} AS C{name}.</span>

<span class="sd">        If C{name} is not given, then a name will automatically be</span>
<span class="sd">        generated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="n">Undef</span><span class="p">:</span>
            <span class="n">Alias</span><span class="o">.</span><span class="n">auto_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;_</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Alias</span><span class="o">.</span><span class="n">auto_counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_python2</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="compile_alias"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_alias">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Alias</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_alias</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">alias</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="ow">is</span> <span class="n">COLUMN</span> <span class="ow">or</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="ow">is</span> <span class="n">TABLE</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> AS </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">alias</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name</span></div>


<span class="c1"># --------------------------------------------------------------------</span>
<span class="c1"># From expressions</span>

<div class="viewcode-block" id="FromExpr"><a class="viewcode-back" href="../../expr.html#storm.expr.FromExpr">[docs]</a><span class="k">class</span> <span class="nc">FromExpr</span><span class="p">(</span><span class="n">Expr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span></div>


<div class="viewcode-block" id="Table"><a class="viewcode-back" href="../../expr.html#storm.expr.Table">[docs]</a><span class="k">class</span> <span class="nc">Table</span><span class="p">(</span><span class="n">FromExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;compile_cache&quot;</span><span class="p">,</span> <span class="s2">&quot;compile_id&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compile_cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compile_id</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="compile_table"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_table">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Table</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_table</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">compile_id</span> <span class="o">!=</span> <span class="nb">id</span><span class="p">(</span><span class="nb">compile</span><span class="p">):</span>
        <span class="n">table</span><span class="o">.</span><span class="n">compile_cache</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">compile_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="nb">compile</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">compile_cache</span></div>


<div class="viewcode-block" id="JoinExpr"><a class="viewcode-back" href="../../expr.html#storm.expr.JoinExpr">[docs]</a><span class="k">class</span> <span class="nc">JoinExpr</span><span class="p">(</span><span class="n">FromExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">)</span>

    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot;(unknown)&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">Undef</span><span class="p">):</span>
        <span class="c1"># http://www.postgresql.org/docs/8.1/interactive/explicit-joins.html</span>
        <span class="k">if</span> <span class="n">arg2</span> <span class="ow">is</span> <span class="n">Undef</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">Undef</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">arg1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on</span> <span class="o">=</span> <span class="n">on</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg2</span><span class="p">,</span> <span class="n">Expr</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg2</span><span class="p">,</span> <span class="p">(</span><span class="n">FromExpr</span><span class="p">,</span> <span class="n">Alias</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">arg1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">arg2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on</span> <span class="o">=</span> <span class="n">on</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">Undef</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">arg1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on</span> <span class="o">=</span> <span class="n">arg2</span>
            <span class="k">if</span> <span class="n">on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ExprError</span><span class="p">(</span><span class="s2">&quot;Improper join arguments: (</span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">on</span><span class="p">))</span></div>

<div class="viewcode-block" id="compile_join"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_join">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">JoinExpr</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_join</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">join</span><span class="o">.</span><span class="n">left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="n">statement</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">join</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">join_tables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">state</span><span class="o">.</span><span class="n">join_tables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">join</span><span class="o">.</span><span class="n">oper</span><span class="p">)</span>
    <span class="c1"># Joins are left associative, so ensure joins in the right hand</span>
    <span class="c1"># argument get parentheses.</span>
    <span class="n">state</span><span class="o">.</span><span class="n">precedence</span> <span class="o">+=</span> <span class="mf">0.5</span>
    <span class="n">statement</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">join</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">join_tables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">join_tables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">join</span><span class="o">.</span><span class="n">on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="n">EXPR</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ON&quot;</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">join</span><span class="o">.</span><span class="n">on</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>


<div class="viewcode-block" id="Join"><a class="viewcode-back" href="../../expr.html#storm.expr.Join">[docs]</a><span class="k">class</span> <span class="nc">Join</span><span class="p">(</span><span class="n">JoinExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot;JOIN&quot;</span></div>

<div class="viewcode-block" id="LeftJoin"><a class="viewcode-back" href="../../expr.html#storm.expr.LeftJoin">[docs]</a><span class="k">class</span> <span class="nc">LeftJoin</span><span class="p">(</span><span class="n">JoinExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot;LEFT JOIN&quot;</span></div>

<div class="viewcode-block" id="RightJoin"><a class="viewcode-back" href="../../expr.html#storm.expr.RightJoin">[docs]</a><span class="k">class</span> <span class="nc">RightJoin</span><span class="p">(</span><span class="n">JoinExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot;RIGHT JOIN&quot;</span></div>

<div class="viewcode-block" id="NaturalJoin"><a class="viewcode-back" href="../../expr.html#storm.expr.NaturalJoin">[docs]</a><span class="k">class</span> <span class="nc">NaturalJoin</span><span class="p">(</span><span class="n">JoinExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot;NATURAL JOIN&quot;</span></div>

<div class="viewcode-block" id="NaturalLeftJoin"><a class="viewcode-back" href="../../expr.html#storm.expr.NaturalLeftJoin">[docs]</a><span class="k">class</span> <span class="nc">NaturalLeftJoin</span><span class="p">(</span><span class="n">JoinExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot;NATURAL LEFT JOIN&quot;</span></div>

<div class="viewcode-block" id="NaturalRightJoin"><a class="viewcode-back" href="../../expr.html#storm.expr.NaturalRightJoin">[docs]</a><span class="k">class</span> <span class="nc">NaturalRightJoin</span><span class="p">(</span><span class="n">JoinExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot;NATURAL RIGHT JOIN&quot;</span></div>


<span class="c1"># --------------------------------------------------------------------</span>
<span class="c1"># Distinct expressions</span>

<div class="viewcode-block" id="Distinct"><a class="viewcode-back" href="../../expr.html#storm.expr.Distinct">[docs]</a><span class="k">class</span> <span class="nc">Distinct</span><span class="p">(</span><span class="n">Expr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add the &#39;DISTINCT&#39; prefix to an expression.&quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;expr&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="compile_distinct"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_distinct">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Distinct</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_distinct</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">distinct</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;DISTINCT </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">compile</span><span class="p">(</span><span class="n">distinct</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span></div>


<span class="c1"># --------------------------------------------------------------------</span>
<span class="c1"># Operators</span>

<div class="viewcode-block" id="BinaryOper"><a class="viewcode-back" href="../../expr.html#storm.expr.BinaryOper">[docs]</a><span class="k">class</span> <span class="nc">BinaryOper</span><span class="p">(</span><span class="n">BinaryExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot; (unknown) &quot;</span></div>

<div class="viewcode-block" id="compile_binary_oper"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_binary_oper">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">BinaryOper</span><span class="p">)</span>
<span class="nd">@compile_python</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">BinaryOper</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_binary_oper</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr1</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span> <span class="n">expr</span><span class="o">.</span><span class="n">oper</span><span class="p">,</span>
                       <span class="nb">compile</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr2</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span></div>


<div class="viewcode-block" id="NonAssocBinaryOper"><a class="viewcode-back" href="../../expr.html#storm.expr.NonAssocBinaryOper">[docs]</a><span class="k">class</span> <span class="nc">NonAssocBinaryOper</span><span class="p">(</span><span class="n">BinaryOper</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot; (unknown) &quot;</span></div>

<div class="viewcode-block" id="compile_non_assoc_binary_oper"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_non_assoc_binary_oper">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">NonAssocBinaryOper</span><span class="p">)</span>
<span class="nd">@compile_python</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">NonAssocBinaryOper</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_non_assoc_binary_oper</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">expr1</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr1</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">precedence</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="c1"># Enforce parentheses.</span>
    <span class="n">expr2</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr2</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">expr1</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">oper</span><span class="p">,</span> <span class="n">expr2</span><span class="p">)</span></div>


<div class="viewcode-block" id="CompoundOper"><a class="viewcode-back" href="../../expr.html#storm.expr.CompoundOper">[docs]</a><span class="k">class</span> <span class="nc">CompoundOper</span><span class="p">(</span><span class="n">CompoundExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot; (unknown) &quot;</span></div>

<span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">CompoundOper</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_compound_oper</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">compile</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">exprs</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="n">expr</span><span class="o">.</span><span class="n">oper</span><span class="p">)</span>

<span class="nd">@compile_python</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">CompoundOper</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_compound_oper</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">compile</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">exprs</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="n">expr</span><span class="o">.</span><span class="n">oper</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>


<div class="viewcode-block" id="Eq"><a class="viewcode-back" href="../../expr.html#storm.expr.Eq">[docs]</a><span class="k">class</span> <span class="nc">Eq</span><span class="p">(</span><span class="n">BinaryOper</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot; = &quot;</span></div>

<span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Eq</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_eq</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">eq</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">eq</span><span class="o">.</span><span class="n">expr2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> IS NULL&quot;</span> <span class="o">%</span> <span class="nb">compile</span><span class="p">(</span><span class="n">eq</span><span class="o">.</span><span class="n">expr1</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">eq</span><span class="o">.</span><span class="n">expr1</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span> <span class="nb">compile</span><span class="p">(</span><span class="n">eq</span><span class="o">.</span><span class="n">expr2</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>

<div class="viewcode-block" id="compile_eq"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_eq">[docs]</a><span class="nd">@compile_python</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Eq</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_eq</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">eq</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> == </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">eq</span><span class="o">.</span><span class="n">expr1</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span> <span class="nb">compile</span><span class="p">(</span><span class="n">eq</span><span class="o">.</span><span class="n">expr2</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span></div>


<div class="viewcode-block" id="Ne"><a class="viewcode-back" href="../../expr.html#storm.expr.Ne">[docs]</a><span class="k">class</span> <span class="nc">Ne</span><span class="p">(</span><span class="n">BinaryOper</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot; != &quot;</span></div>

<div class="viewcode-block" id="compile_ne"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_ne">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Ne</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_ne</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ne</span><span class="o">.</span><span class="n">expr2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> IS NOT NULL&quot;</span> <span class="o">%</span> <span class="nb">compile</span><span class="p">(</span><span class="n">ne</span><span class="o">.</span><span class="n">expr1</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> != </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">ne</span><span class="o">.</span><span class="n">expr1</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span> <span class="nb">compile</span><span class="p">(</span><span class="n">ne</span><span class="o">.</span><span class="n">expr2</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span></div>


<div class="viewcode-block" id="Gt"><a class="viewcode-back" href="../../expr.html#storm.expr.Gt">[docs]</a><span class="k">class</span> <span class="nc">Gt</span><span class="p">(</span><span class="n">BinaryOper</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot; &gt; &quot;</span></div>

<div class="viewcode-block" id="Ge"><a class="viewcode-back" href="../../expr.html#storm.expr.Ge">[docs]</a><span class="k">class</span> <span class="nc">Ge</span><span class="p">(</span><span class="n">BinaryOper</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot; &gt;= &quot;</span></div>

<div class="viewcode-block" id="Lt"><a class="viewcode-back" href="../../expr.html#storm.expr.Lt">[docs]</a><span class="k">class</span> <span class="nc">Lt</span><span class="p">(</span><span class="n">BinaryOper</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot; &lt; &quot;</span></div>

<div class="viewcode-block" id="Le"><a class="viewcode-back" href="../../expr.html#storm.expr.Le">[docs]</a><span class="k">class</span> <span class="nc">Le</span><span class="p">(</span><span class="n">BinaryOper</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot; &lt;= &quot;</span></div>

<div class="viewcode-block" id="RShift"><a class="viewcode-back" href="../../expr.html#storm.expr.RShift">[docs]</a><span class="k">class</span> <span class="nc">RShift</span><span class="p">(</span><span class="n">BinaryOper</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot;&gt;&gt;&quot;</span></div>

<div class="viewcode-block" id="LShift"><a class="viewcode-back" href="../../expr.html#storm.expr.LShift">[docs]</a><span class="k">class</span> <span class="nc">LShift</span><span class="p">(</span><span class="n">BinaryOper</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot;&lt;&lt;&quot;</span></div>


<div class="viewcode-block" id="Like"><a class="viewcode-back" href="../../expr.html#storm.expr.Like">[docs]</a><span class="k">class</span> <span class="nc">Like</span><span class="p">(</span><span class="n">BinaryOper</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;escape&quot;</span><span class="p">,</span> <span class="s2">&quot;case_sensitive&quot;</span><span class="p">)</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot; LIKE &quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr1</span><span class="p">,</span> <span class="n">expr2</span><span class="p">,</span> <span class="n">escape</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span> <span class="n">case_sensitive</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expr1</span> <span class="o">=</span> <span class="n">expr1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expr2</span> <span class="o">=</span> <span class="n">expr2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">escape</span> <span class="o">=</span> <span class="n">escape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case_sensitive</span> <span class="o">=</span> <span class="n">case_sensitive</span></div>

<div class="viewcode-block" id="compile_like"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_like">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Like</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_like</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">like</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">oper</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">statement</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">like</span><span class="o">.</span><span class="n">expr1</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span> <span class="n">oper</span> <span class="ow">or</span> <span class="n">like</span><span class="o">.</span><span class="n">oper</span><span class="p">,</span>
                            <span class="nb">compile</span><span class="p">(</span><span class="n">like</span><span class="o">.</span><span class="n">expr2</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">like</span><span class="o">.</span><span class="n">escape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="n">statement</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> ESCAPE </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="nb">compile</span><span class="p">(</span><span class="n">like</span><span class="o">.</span><span class="n">escape</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">statement</span></div>

<span class="c1"># It&#39;s easy to support it. Later.</span>
<span class="n">compile_python</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Like</span><span class="p">)(</span><span class="n">compile_python_unsupported</span><span class="p">)</span>


<div class="viewcode-block" id="In"><a class="viewcode-back" href="../../expr.html#storm.expr.In">[docs]</a><span class="k">class</span> <span class="nc">In</span><span class="p">(</span><span class="n">BinaryOper</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot; IN &quot;</span></div>

<span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">In</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_in</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">expr1</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr1</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">precedence</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># We&#39;re forcing parenthesis here.</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> IN (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">expr1</span><span class="p">,</span> <span class="nb">compile</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr2</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>

<div class="viewcode-block" id="compile_in"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_in">[docs]</a><span class="nd">@compile_python</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">In</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_in</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">expr1</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr1</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">precedence</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># We&#39;re forcing parenthesis here.</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> in (</span><span class="si">%s</span><span class="s2">,)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">expr1</span><span class="p">,</span> <span class="nb">compile</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr2</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span></div>


<div class="viewcode-block" id="Add"><a class="viewcode-back" href="../../expr.html#storm.expr.Add">[docs]</a><span class="k">class</span> <span class="nc">Add</span><span class="p">(</span><span class="n">CompoundOper</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span></div>

<div class="viewcode-block" id="Sub"><a class="viewcode-back" href="../../expr.html#storm.expr.Sub">[docs]</a><span class="k">class</span> <span class="nc">Sub</span><span class="p">(</span><span class="n">NonAssocBinaryOper</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span></div>

<div class="viewcode-block" id="Mul"><a class="viewcode-back" href="../../expr.html#storm.expr.Mul">[docs]</a><span class="k">class</span> <span class="nc">Mul</span><span class="p">(</span><span class="n">CompoundOper</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span></div>

<div class="viewcode-block" id="Div"><a class="viewcode-back" href="../../expr.html#storm.expr.Div">[docs]</a><span class="k">class</span> <span class="nc">Div</span><span class="p">(</span><span class="n">NonAssocBinaryOper</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span></div>

<div class="viewcode-block" id="Mod"><a class="viewcode-back" href="../../expr.html#storm.expr.Mod">[docs]</a><span class="k">class</span> <span class="nc">Mod</span><span class="p">(</span><span class="n">NonAssocBinaryOper</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot;%&quot;</span></div>


<div class="viewcode-block" id="And"><a class="viewcode-back" href="../../expr.html#storm.expr.And">[docs]</a><span class="k">class</span> <span class="nc">And</span><span class="p">(</span><span class="n">CompoundOper</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot; AND &quot;</span></div>

<div class="viewcode-block" id="Or"><a class="viewcode-back" href="../../expr.html#storm.expr.Or">[docs]</a><span class="k">class</span> <span class="nc">Or</span><span class="p">(</span><span class="n">CompoundOper</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot; OR &quot;</span></div>

<div class="viewcode-block" id="compile_compound_oper"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_compound_oper">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">And</span><span class="p">,</span> <span class="n">Or</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_compound_oper</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">compile</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">exprs</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="n">expr</span><span class="o">.</span><span class="n">oper</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<span class="c1"># --------------------------------------------------------------------</span>
<span class="c1"># Set expressions.</span>

<div class="viewcode-block" id="SetExpr"><a class="viewcode-back" href="../../expr.html#storm.expr.SetExpr">[docs]</a><span class="k">class</span> <span class="nc">SetExpr</span><span class="p">(</span><span class="n">Expr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;exprs&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;order_by&quot;</span><span class="p">,</span> <span class="s2">&quot;limit&quot;</span><span class="p">,</span> <span class="s2">&quot;offset&quot;</span><span class="p">)</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot; (unknown) &quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exprs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span> <span class="o">=</span> <span class="n">exprs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;order_by&quot;</span><span class="p">,</span> <span class="n">Undef</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limit&quot;</span><span class="p">,</span> <span class="n">Undef</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;offset&quot;</span><span class="p">,</span> <span class="n">Undef</span><span class="p">)</span>
        <span class="c1"># If the first expression is of a compatible type, directly</span>
        <span class="c1"># include its sub expressions.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">first</span><span class="o">.</span><span class="n">all</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">all</span> <span class="ow">and</span>
                <span class="n">first</span><span class="o">.</span><span class="n">limit</span> <span class="ow">is</span> <span class="n">Undef</span> <span class="ow">and</span>
                <span class="n">first</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="n">Undef</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">exprs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">exprs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span></div>


<div class="viewcode-block" id="compile_set_expr"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_set_expr">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">SetExpr</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_set_expr</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">order_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="c1"># When ORDER BY is present, databases usually have trouble using</span>
        <span class="c1"># fully qualified column names.  Because of that, we transform</span>
        <span class="c1"># pure column names into aliases, and use them in the ORDER BY.</span>
        <span class="n">aliases</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">subexpr</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">exprs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subexpr</span><span class="p">,</span> <span class="n">Select</span><span class="p">):</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="n">subexpr</span><span class="o">.</span><span class="n">columns</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">columns</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">Column</span><span class="p">):</span>
                            <span class="n">aliases</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Alias</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">Alias</span><span class="p">):</span>
                            <span class="n">aliases</span><span class="p">[</span><span class="n">column</span><span class="o">.</span><span class="n">expr</span><span class="p">]</span> <span class="o">=</span> <span class="n">column</span>
                <span class="n">subexpr</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span>

    <span class="n">state</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="n">SELECT</span><span class="p">)</span>
    <span class="c1"># In the statement:</span>
    <span class="c1">#   SELECT foo UNION SELECT bar LIMIT 1</span>
    <span class="c1"># The LIMIT 1 applies to the union results, not the SELECT bar</span>
    <span class="c1"># This ensures that parentheses will be placed around the</span>
    <span class="c1"># sub-selects in the expression.</span>
    <span class="n">state</span><span class="o">.</span><span class="n">precedence</span> <span class="o">+=</span> <span class="mf">0.5</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">oper</span>
    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">oper</span> <span class="o">+=</span> <span class="s2">&quot;ALL &quot;</span>
    <span class="n">statement</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">exprs</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="n">oper</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">precedence</span> <span class="o">-=</span> <span class="mf">0.5</span>
    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">order_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">COLUMN_NAME</span>
        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">aliases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">state</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s2">&quot;aliases&quot;</span><span class="p">,</span> <span class="n">aliases</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Previously defined aliases have precedence.</span>
            <span class="n">aliases</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">aliases</span><span class="p">)</span>
            <span class="n">state</span><span class="o">.</span><span class="n">aliases</span> <span class="o">=</span> <span class="n">aliases</span>
            <span class="n">aliases</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">statement</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY &quot;</span> <span class="o">+</span> <span class="nb">compile</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">order_by</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">aliases</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="n">statement</span> <span class="o">+=</span> <span class="s2">&quot; LIMIT </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">expr</span><span class="o">.</span><span class="n">limit</span>
    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="n">statement</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">expr</span><span class="o">.</span><span class="n">offset</span>
    <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">statement</span></div>


<div class="viewcode-block" id="Union"><a class="viewcode-back" href="../../expr.html#storm.expr.Union">[docs]</a><span class="k">class</span> <span class="nc">Union</span><span class="p">(</span><span class="n">SetExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot; UNION &quot;</span></div>

<div class="viewcode-block" id="Except"><a class="viewcode-back" href="../../expr.html#storm.expr.Except">[docs]</a><span class="k">class</span> <span class="nc">Except</span><span class="p">(</span><span class="n">SetExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot; EXCEPT &quot;</span></div>

<div class="viewcode-block" id="Intersect"><a class="viewcode-back" href="../../expr.html#storm.expr.Intersect">[docs]</a><span class="k">class</span> <span class="nc">Intersect</span><span class="p">(</span><span class="n">SetExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">oper</span> <span class="o">=</span> <span class="s2">&quot; INTERSECT &quot;</span></div>


<span class="c1"># --------------------------------------------------------------------</span>
<span class="c1"># Functions</span>

<div class="viewcode-block" id="FuncExpr"><a class="viewcode-back" href="../../expr.html#storm.expr.FuncExpr">[docs]</a><span class="k">class</span> <span class="nc">FuncExpr</span><span class="p">(</span><span class="n">ComparableExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;(unknown)&quot;</span></div>


<div class="viewcode-block" id="Count"><a class="viewcode-back" href="../../expr.html#storm.expr.Count">[docs]</a><span class="k">class</span> <span class="nc">Count</span><span class="p">(</span><span class="n">FuncExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;column&quot;</span><span class="p">,</span> <span class="s2">&quot;distinct&quot;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;COUNT&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">distinct</span> <span class="ow">and</span> <span class="n">column</span> <span class="ow">is</span> <span class="n">Undef</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must specify column when using distinct count&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distinct</span> <span class="o">=</span> <span class="n">distinct</span></div>

<div class="viewcode-block" id="compile_count"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_count">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Count</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_count</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">count</span><span class="o">.</span><span class="n">column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="n">EXPR</span><span class="p">)</span>
        <span class="n">column</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">count</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">count</span><span class="o">.</span><span class="n">distinct</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;COUNT(DISTINCT </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">column</span>
        <span class="k">return</span> <span class="s2">&quot;COUNT(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">column</span>
    <span class="k">return</span> <span class="s2">&quot;COUNT(*)&quot;</span></div>


<div class="viewcode-block" id="Func"><a class="viewcode-back" href="../../expr.html#storm.expr.Func">[docs]</a><span class="k">class</span> <span class="nc">Func</span><span class="p">(</span><span class="n">FuncExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;args&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span></div>

<div class="viewcode-block" id="NamedFunc"><a class="viewcode-back" href="../../expr.html#storm.expr.NamedFunc">[docs]</a><span class="k">class</span> <span class="nc">NamedFunc</span><span class="p">(</span><span class="n">FuncExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span></div>

<div class="viewcode-block" id="compile_func"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_func">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Func</span><span class="p">,</span> <span class="n">NamedFunc</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_func</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="n">state</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="n">EXPR</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span></div>


<div class="viewcode-block" id="Max"><a class="viewcode-back" href="../../expr.html#storm.expr.Max">[docs]</a><span class="k">class</span> <span class="nc">Max</span><span class="p">(</span><span class="n">NamedFunc</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;MAX&quot;</span></div>

<div class="viewcode-block" id="Min"><a class="viewcode-back" href="../../expr.html#storm.expr.Min">[docs]</a><span class="k">class</span> <span class="nc">Min</span><span class="p">(</span><span class="n">NamedFunc</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;MIN&quot;</span></div>

<div class="viewcode-block" id="Avg"><a class="viewcode-back" href="../../expr.html#storm.expr.Avg">[docs]</a><span class="k">class</span> <span class="nc">Avg</span><span class="p">(</span><span class="n">NamedFunc</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;AVG&quot;</span></div>

<div class="viewcode-block" id="Sum"><a class="viewcode-back" href="../../expr.html#storm.expr.Sum">[docs]</a><span class="k">class</span> <span class="nc">Sum</span><span class="p">(</span><span class="n">NamedFunc</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;SUM&quot;</span></div>


<div class="viewcode-block" id="Lower"><a class="viewcode-back" href="../../expr.html#storm.expr.Lower">[docs]</a><span class="k">class</span> <span class="nc">Lower</span><span class="p">(</span><span class="n">NamedFunc</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;LOWER&quot;</span></div>

<div class="viewcode-block" id="Upper"><a class="viewcode-back" href="../../expr.html#storm.expr.Upper">[docs]</a><span class="k">class</span> <span class="nc">Upper</span><span class="p">(</span><span class="n">NamedFunc</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;UPPER&quot;</span></div>


<div class="viewcode-block" id="Coalesce"><a class="viewcode-back" href="../../expr.html#storm.expr.Coalesce">[docs]</a><span class="k">class</span> <span class="nc">Coalesce</span><span class="p">(</span><span class="n">NamedFunc</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;COALESCE&quot;</span></div>


<div class="viewcode-block" id="Row"><a class="viewcode-back" href="../../expr.html#storm.expr.Row">[docs]</a><span class="k">class</span> <span class="nc">Row</span><span class="p">(</span><span class="n">NamedFunc</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;ROW&quot;</span></div>


<div class="viewcode-block" id="Cast"><a class="viewcode-back" href="../../expr.html#storm.expr.Cast">[docs]</a><span class="k">class</span> <span class="nc">Cast</span><span class="p">(</span><span class="n">FuncExpr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A representation of C{CAST} clauses. e.g., C{CAST(bar AS TEXT)}.&quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;column&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;CAST&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a cast of C{column} as C{type}.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span></div>


<div class="viewcode-block" id="compile_cast"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_cast">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Cast</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_cast</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">cast</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compile L{Cast} expressions.&quot;&quot;&quot;</span>
    <span class="n">state</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="n">EXPR</span><span class="p">)</span>
    <span class="n">column</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">cast</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">return</span> <span class="s2">&quot;CAST(</span><span class="si">%s</span><span class="s2"> AS </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">cast</span><span class="o">.</span><span class="n">type</span><span class="p">)</span></div>


<span class="c1"># --------------------------------------------------------------------</span>
<span class="c1"># Prefix and suffix expressions</span>

<div class="viewcode-block" id="PrefixExpr"><a class="viewcode-back" href="../../expr.html#storm.expr.PrefixExpr">[docs]</a><span class="k">class</span> <span class="nc">PrefixExpr</span><span class="p">(</span><span class="n">Expr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;expr&quot;</span><span class="p">,)</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;(unknown)&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="compile_prefix_expr"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_prefix_expr">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">PrefixExpr</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_prefix_expr</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="nb">compile</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span></div>


<div class="viewcode-block" id="SuffixExpr"><a class="viewcode-back" href="../../expr.html#storm.expr.SuffixExpr">[docs]</a><span class="k">class</span> <span class="nc">SuffixExpr</span><span class="p">(</span><span class="n">Expr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;expr&quot;</span><span class="p">,)</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;(unknown)&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span></div>

<div class="viewcode-block" id="compile_suffix_expr"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_suffix_expr">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">SuffixExpr</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_suffix_expr</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">expr</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span></div>


<div class="viewcode-block" id="Not"><a class="viewcode-back" href="../../expr.html#storm.expr.Not">[docs]</a><span class="k">class</span> <span class="nc">Not</span><span class="p">(</span><span class="n">PrefixExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;NOT&quot;</span></div>

<div class="viewcode-block" id="Exists"><a class="viewcode-back" href="../../expr.html#storm.expr.Exists">[docs]</a><span class="k">class</span> <span class="nc">Exists</span><span class="p">(</span><span class="n">PrefixExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;EXISTS&quot;</span></div>

<div class="viewcode-block" id="Neg"><a class="viewcode-back" href="../../expr.html#storm.expr.Neg">[docs]</a><span class="k">class</span> <span class="nc">Neg</span><span class="p">(</span><span class="n">PrefixExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span></div>

<div class="viewcode-block" id="compile_neg_expr"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_neg_expr">[docs]</a><span class="nd">@compile_python</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">Neg</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_neg_expr</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">compile</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Asc"><a class="viewcode-back" href="../../expr.html#storm.expr.Asc">[docs]</a><span class="k">class</span> <span class="nc">Asc</span><span class="p">(</span><span class="n">SuffixExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;ASC&quot;</span></div>

<div class="viewcode-block" id="Desc"><a class="viewcode-back" href="../../expr.html#storm.expr.Desc">[docs]</a><span class="k">class</span> <span class="nc">Desc</span><span class="p">(</span><span class="n">SuffixExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;DESC&quot;</span></div>


<span class="c1"># --------------------------------------------------------------------</span>
<span class="c1"># Plain SQL expressions.</span>

<div class="viewcode-block" id="SQLRaw"><a class="viewcode-back" href="../../expr.html#storm.expr.SQLRaw">[docs]</a><span class="k">class</span> <span class="nc">SQLRaw</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Subtype to mark a string as something that shouldn&#39;t be compiled.</span>

<span class="sd">    This is handled internally by the compiler.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span></div>


<div class="viewcode-block" id="SQLToken"><a class="viewcode-back" href="../../expr.html#storm.expr.SQLToken">[docs]</a><span class="k">class</span> <span class="nc">SQLToken</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Marker for strings that should be considered as a single SQL token.</span>

<span class="sd">    These strings will be quoted, when needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span></div>

<span class="n">is_safe_token</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^[a-zA-Z][a-zA-Z0-9_]*$&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span>

<div class="viewcode-block" id="compile_sql_token"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_sql_token">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">SQLToken</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_sql_token</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">is_safe_token</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">compile</span><span class="o">.</span><span class="n">is_reserved_word</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">expr</span>
    <span class="k">return</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="compile_python_sql_token"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_python_sql_token">[docs]</a><span class="nd">@compile_python</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">SQLToken</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_python_sql_token</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">expr</span></div>


<div class="viewcode-block" id="SQL"><a class="viewcode-back" href="../../expr.html#storm.expr.SQL">[docs]</a><span class="k">class</span> <span class="nc">SQL</span><span class="p">(</span><span class="n">ComparableExpr</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;expr&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">,</span> <span class="s2">&quot;tables&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">Undef</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">Undef</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="n">tables</span></div>

<div class="viewcode-block" id="compile_sql"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_sql">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">SQL</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_sql</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">params</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CompileError</span><span class="p">(</span><span class="s2">&quot;Parameters should be a list or a tuple, &quot;</span>
                               <span class="s2">&quot;not </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">params</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="n">state</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">tables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undef</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">auto_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">tables</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">expr</span><span class="o">.</span><span class="n">expr</span></div>


<span class="c1"># --------------------------------------------------------------------</span>
<span class="c1"># Sequences.</span>

<div class="viewcode-block" id="Sequence"><a class="viewcode-back" href="../../expr.html#storm.expr.Sequence">[docs]</a><span class="k">class</span> <span class="nc">Sequence</span><span class="p">(</span><span class="n">Expr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Expression representing auto-incrementing support from the database.</span>

<span class="sd">    This should be translated into the *next* value of the named</span>
<span class="sd">    auto-incrementing sequence.  There&#39;s no standard way to compile a</span>
<span class="sd">    sequence, since it&#39;s very database-dependent.</span>

<span class="sd">    This may be used as follows::</span>

<span class="sd">      class Class(object):</span>
<span class="sd">          (...)</span>
<span class="sd">          id = Int(default=Sequence(&quot;my_sequence_name&quot;))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span></div>


<span class="c1"># --------------------------------------------------------------------</span>
<span class="c1"># Utility functions.</span>

<div class="viewcode-block" id="compare_columns"><a class="viewcode-back" href="../../expr.html#storm.expr.compare_columns">[docs]</a><span class="k">def</span> <span class="nf">compare_columns</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">columns</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Undef</span>
    <span class="n">equals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Variable</span><span class="p">))</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">variable_factory</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Eq</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Variable</span><span class="p">))</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">variable_factory</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
            <span class="n">equals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Eq</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">And</span><span class="p">(</span><span class="o">*</span><span class="n">equals</span><span class="p">)</span></div>


<span class="c1"># --------------------------------------------------------------------</span>
<span class="c1"># Auto table</span>

<div class="viewcode-block" id="AutoTables"><a class="viewcode-back" href="../../expr.html#storm.expr.AutoTables">[docs]</a><span class="k">class</span> <span class="nc">AutoTables</span><span class="p">(</span><span class="n">Expr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class will inject one or more entries in state.auto_tables.</span>

<span class="sd">    If the constructor is passed replace=True, it will also discard any</span>
<span class="sd">    auto_table entries injected by compiling the given expression.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;expr&quot;</span><span class="p">,</span> <span class="s2">&quot;tables&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="n">tables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replace</span> <span class="o">=</span> <span class="n">replace</span></div>

<div class="viewcode-block" id="compile_auto_tables"><a class="viewcode-back" href="../../expr.html#storm.expr.compile_auto_tables">[docs]</a><span class="nd">@compile</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">AutoTables</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_auto_tables</span><span class="p">(</span><span class="nb">compile</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="s2">&quot;auto_tables&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">statement</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="n">state</span><span class="o">.</span><span class="n">auto_tables</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">tables</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">statement</span></div>


<span class="c1"># --------------------------------------------------------------------</span>
<span class="c1"># Set operator precedences.</span>

<span class="nb">compile</span><span class="o">.</span><span class="n">set_precedence</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">Select</span><span class="p">,</span> <span class="n">Insert</span><span class="p">,</span> <span class="n">Update</span><span class="p">,</span> <span class="n">Delete</span><span class="p">)</span>
<span class="nb">compile</span><span class="o">.</span><span class="n">set_precedence</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">Join</span><span class="p">,</span> <span class="n">LeftJoin</span><span class="p">,</span> <span class="n">RightJoin</span><span class="p">)</span>
<span class="nb">compile</span><span class="o">.</span><span class="n">set_precedence</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">NaturalJoin</span><span class="p">,</span> <span class="n">NaturalLeftJoin</span><span class="p">,</span> <span class="n">NaturalRightJoin</span><span class="p">)</span>
<span class="nb">compile</span><span class="o">.</span><span class="n">set_precedence</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Except</span><span class="p">,</span> <span class="n">Intersect</span><span class="p">)</span>
<span class="nb">compile</span><span class="o">.</span><span class="n">set_precedence</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">SQL</span><span class="p">)</span>
<span class="nb">compile</span><span class="o">.</span><span class="n">set_precedence</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">Or</span><span class="p">)</span>
<span class="nb">compile</span><span class="o">.</span><span class="n">set_precedence</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">And</span><span class="p">)</span>
<span class="nb">compile</span><span class="o">.</span><span class="n">set_precedence</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">Eq</span><span class="p">,</span> <span class="n">Ne</span><span class="p">,</span> <span class="n">Gt</span><span class="p">,</span> <span class="n">Ge</span><span class="p">,</span> <span class="n">Lt</span><span class="p">,</span> <span class="n">Le</span><span class="p">,</span> <span class="n">Like</span><span class="p">,</span> <span class="n">In</span><span class="p">)</span>
<span class="nb">compile</span><span class="o">.</span><span class="n">set_precedence</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">LShift</span><span class="p">,</span> <span class="n">RShift</span><span class="p">)</span>
<span class="nb">compile</span><span class="o">.</span><span class="n">set_precedence</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span> <span class="n">Add</span><span class="p">,</span> <span class="n">Sub</span><span class="p">)</span>
<span class="nb">compile</span><span class="o">.</span><span class="n">set_precedence</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="n">Mul</span><span class="p">,</span> <span class="n">Div</span><span class="p">,</span> <span class="n">Mod</span><span class="p">)</span>

<span class="n">compile_python</span><span class="o">.</span><span class="n">set_precedence</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">Or</span><span class="p">)</span>
<span class="n">compile_python</span><span class="o">.</span><span class="n">set_precedence</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">And</span><span class="p">)</span>
<span class="n">compile_python</span><span class="o">.</span><span class="n">set_precedence</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">Eq</span><span class="p">,</span> <span class="n">Ne</span><span class="p">,</span> <span class="n">Gt</span><span class="p">,</span> <span class="n">Ge</span><span class="p">,</span> <span class="n">Lt</span><span class="p">,</span> <span class="n">Le</span><span class="p">,</span> <span class="n">Like</span><span class="p">,</span> <span class="n">In</span><span class="p">)</span>
<span class="n">compile_python</span><span class="o">.</span><span class="n">set_precedence</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">LShift</span><span class="p">,</span> <span class="n">RShift</span><span class="p">)</span>
<span class="n">compile_python</span><span class="o">.</span><span class="n">set_precedence</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">Add</span><span class="p">,</span> <span class="n">Sub</span><span class="p">)</span>
<span class="n">compile_python</span><span class="o">.</span><span class="n">set_precedence</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">Mul</span><span class="p">,</span> <span class="n">Div</span><span class="p">,</span> <span class="n">Mod</span><span class="p">)</span>


<span class="c1"># --------------------------------------------------------------------</span>
<span class="c1"># Reserved words, from SQL1992</span>

<span class="nb">compile</span><span class="o">.</span><span class="n">add_reserved_words</span><span class="p">(</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    absolute action add all allocate alter and any are as asc assertion at</span>
<span class="sd">    authorization avg begin between bit bit_length both by cascade cascaded</span>
<span class="sd">    case cast catalog char character char_ length character_length check close</span>
<span class="sd">    coalesce collate collation column commit connect connection constraint</span>
<span class="sd">    constraints continue convert corresponding count create cross current</span>
<span class="sd">    current_date current_time current_timestamp current_ user cursor date day</span>
<span class="sd">    deallocate dec decimal declare default deferrable deferred delete desc</span>
<span class="sd">    describe descriptor diagnostics disconnect distinct domain double drop</span>
<span class="sd">    else end end-exec escape except exception exec execute exists external</span>
<span class="sd">    extract false fetch first float for foreign found from full get global go</span>
<span class="sd">    goto grant group having hour identity immediate in indicator initially</span>
<span class="sd">    inner input insensitive insert int integer intersect interval into is</span>
<span class="sd">    isolation join key language last leading left level like local lower</span>
<span class="sd">    match max min minute module month names national natural nchar next no</span>
<span class="sd">    not null nullif numeric octet_length of on only open option or order</span>
<span class="sd">    outer output overlaps pad partial position precision prepare preserve</span>
<span class="sd">    primary prior privileges procedure public read real references relative</span>
<span class="sd">    restrict revoke right rollback rows schema scroll second section select</span>
<span class="sd">    session session_ user set size smallint some space sql sqlcode sqlerror</span>
<span class="sd">    sqlstate substring sum system_user table temporary then time timestamp</span>
<span class="sd">    timezone_ hour timezone_minute to trailing transaction translate</span>
<span class="sd">    translation trim true union unique unknown update upper usage user using</span>
<span class="sd">    value values varchar varying view when whenever where with work write</span>
<span class="sd">    year zone</span>
<span class="sd">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Storm</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../basic-usage.html">Basic usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infoheritance.html">Infoheritance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../store.html">Store</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../columns.html">Columns and types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../expr.html">Expressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../databases.html">Databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../events.html">Hooks and events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../miscellaneous.html">Miscellaneous libraries</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Gustavo Niemeyer.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>