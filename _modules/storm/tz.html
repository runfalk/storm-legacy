
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>storm.tz &#8212; Storm  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for storm.tz</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Copyright (c) 2003-2005  Gustavo Niemeyer &lt;gustavo@niemeyer.net&gt;</span>

<span class="sd">This module offers extensions to the standard python 2.3+</span>
<span class="sd">datetime module.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Gustavo Niemeyer &lt;gustavo@niemeyer.net&gt;&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;PSF License&quot;</span>


<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">storm.compat</span> <span class="k">import</span> <span class="n">iter_keys</span><span class="p">,</span> <span class="n">iter_range</span>


<span class="n">relativedelta</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">parser</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">rrule</span> <span class="o">=</span> <span class="kc">None</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tzutc&quot;</span><span class="p">,</span> <span class="s2">&quot;tzoffset&quot;</span><span class="p">,</span> <span class="s2">&quot;tzlocal&quot;</span><span class="p">,</span> <span class="s2">&quot;tzfile&quot;</span><span class="p">,</span> <span class="s2">&quot;tzrange&quot;</span><span class="p">,</span>
           <span class="s2">&quot;tzstr&quot;</span><span class="p">,</span> <span class="s2">&quot;tzical&quot;</span><span class="p">,</span> <span class="s2">&quot;tzwin&quot;</span><span class="p">,</span> <span class="s2">&quot;tzwinlocal&quot;</span><span class="p">,</span> <span class="s2">&quot;gettz&quot;</span><span class="p">]</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">dateutil.tzwin</span> <span class="k">import</span> <span class="n">tzwin</span><span class="p">,</span> <span class="n">tzwinlocal</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
    <span class="n">tzwin</span><span class="p">,</span> <span class="n">tzwinlocal</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>


<span class="n">ZERO</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">EPOCHORDINAL</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span>


<div class="viewcode-block" id="tzutc"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzutc">[docs]</a><span class="k">class</span> <span class="nc">tzutc</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">):</span>
<div class="viewcode-block" id="tzutc.utcoffset"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzutc.utcoffset">[docs]</a>    <span class="k">def</span> <span class="nf">utcoffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ZERO</span></div>

<div class="viewcode-block" id="tzutc.dst"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzutc.dst">[docs]</a>    <span class="k">def</span> <span class="nf">dst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ZERO</span></div>

<div class="viewcode-block" id="tzutc.tzname"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzutc.tzname">[docs]</a>    <span class="k">def</span> <span class="nf">tzname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;UTC&quot;</span></div>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">tzutc</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">tzoffset</span><span class="p">)</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">_offset</span> <span class="o">==</span> <span class="n">ZERO</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">()&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="n">__reduce__</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__reduce__</span></div>


<div class="viewcode-block" id="tzoffset"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzoffset">[docs]</a><span class="k">class</span> <span class="nc">tzoffset</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span>

<div class="viewcode-block" id="tzoffset.utcoffset"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzoffset.utcoffset">[docs]</a>    <span class="k">def</span> <span class="nf">utcoffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span></div>

<div class="viewcode-block" id="tzoffset.dst"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzoffset.dst">[docs]</a>    <span class="k">def</span> <span class="nf">dst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ZERO</span></div>

<div class="viewcode-block" id="tzoffset.tzname"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzoffset.tzname">[docs]</a>    <span class="k">def</span> <span class="nf">tzname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span></div>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">tzoffset</span><span class="p">)</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_offset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                               <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">),</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="o">.</span><span class="n">days</span><span class="o">*</span><span class="mi">86400</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="o">.</span><span class="n">seconds</span><span class="p">)</span>

    <span class="n">__reduce__</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__reduce__</span></div>


<div class="viewcode-block" id="tzlocal"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzlocal">[docs]</a><span class="k">class</span> <span class="nc">tzlocal</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">):</span>
    <span class="n">_std_offset</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=-</span><span class="n">time</span><span class="o">.</span><span class="n">timezone</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">daylight</span><span class="p">:</span>
        <span class="n">_dst_offset</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=-</span><span class="n">time</span><span class="o">.</span><span class="n">altzone</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_dst_offset</span> <span class="o">=</span> <span class="n">_std_offset</span>

<div class="viewcode-block" id="tzlocal.utcoffset"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzlocal.utcoffset">[docs]</a>    <span class="k">def</span> <span class="nf">utcoffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdst</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span></div>

<div class="viewcode-block" id="tzlocal.dst"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzlocal.dst">[docs]</a>    <span class="k">def</span> <span class="nf">dst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdst</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ZERO</span></div>

<div class="viewcode-block" id="tzlocal.tzname"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzlocal.tzname">[docs]</a>    <span class="k">def</span> <span class="nf">tzname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">tzname</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_isdst</span><span class="p">(</span><span class="n">dt</span><span class="p">)]</span></div>

    <span class="k">def</span> <span class="nf">_isdst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="c1"># We can&#39;t use mktime here. It is unstable when deciding if</span>
        <span class="c1"># the hour near to a change is DST or not.</span>
        <span class="c1">#</span>
        <span class="c1"># timestamp = time.mktime((dt.year, dt.month, dt.day, dt.hour,</span>
        <span class="c1">#                         dt.minute, dt.second, dt.weekday(), 0, -1))</span>
        <span class="c1"># return time.localtime(timestamp).tm_isdst</span>
        <span class="c1">#</span>
        <span class="c1"># The code above yields the following result:</span>
        <span class="c1">#</span>
        <span class="c1">#&gt;&gt;&gt; import tz, datetime</span>
        <span class="c1">#&gt;&gt;&gt; t = tz.tzlocal()</span>
        <span class="c1">#&gt;&gt;&gt; datetime.datetime(2003,2,15,23,tzinfo=t).tzname()</span>
        <span class="c1">#&#39;BRDT&#39;</span>
        <span class="c1">#&gt;&gt;&gt; datetime.datetime(2003,2,16,0,tzinfo=t).tzname()</span>
        <span class="c1">#&#39;BRST&#39;</span>
        <span class="c1">#&gt;&gt;&gt; datetime.datetime(2003,2,15,23,tzinfo=t).tzname()</span>
        <span class="c1">#&#39;BRST&#39;</span>
        <span class="c1">#&gt;&gt;&gt; datetime.datetime(2003,2,15,22,tzinfo=t).tzname()</span>
        <span class="c1">#&#39;BRDT&#39;</span>
        <span class="c1">#&gt;&gt;&gt; datetime.datetime(2003,2,15,23,tzinfo=t).tzname()</span>
        <span class="c1">#&#39;BRDT&#39;</span>
        <span class="c1">#</span>
        <span class="c1"># Here is a more stable implementation:</span>
        <span class="c1">#</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="p">((</span><span class="n">dt</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span> <span class="o">-</span> <span class="n">EPOCHORDINAL</span><span class="p">)</span> <span class="o">*</span> <span class="mi">86400</span>
                     <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">hour</span> <span class="o">*</span> <span class="mi">3600</span>
                     <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">minute</span> <span class="o">*</span> <span class="mi">60</span>
                     <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">timestamp</span><span class="o">+</span><span class="n">time</span><span class="o">.</span><span class="n">timezone</span><span class="p">)</span><span class="o">.</span><span class="n">tm_isdst</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">tzlocal</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_std_offset</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_dst_offset</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">()&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="n">__reduce__</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__reduce__</span></div>


<span class="k">class</span> <span class="nc">_ttinfo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">,</span> <span class="s2">&quot;delta&quot;</span><span class="p">,</span> <span class="s2">&quot;isdst&quot;</span><span class="p">,</span> <span class="s2">&quot;abbr&quot;</span><span class="p">,</span> <span class="s2">&quot;isstd&quot;</span><span class="p">,</span> <span class="s2">&quot;isgmt&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">_ttinfo</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">offset</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">delta</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">isdst</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">isdst</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">abbr</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">abbr</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">isstd</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">isstd</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">isgmt</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">isgmt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">:</span>
            <span class="n">state</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>


<div class="viewcode-block" id="tzfile"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzfile">[docs]</a><span class="k">class</span> <span class="nc">tzfile</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">):</span>
    <span class="c1"># http://www.twinsun.com/tz/tz-link.htm</span>
    <span class="c1"># ftp://elsie.nci.nih.gov/pub/tz*.tar.gz</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">fileobj</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>

        <span class="c1"># From tzfile(5):</span>
        <span class="c1">#</span>
        <span class="c1"># The time zone information files used by tzset(3)</span>
        <span class="c1"># begin with the magic characters &quot;TZif&quot; to identify</span>
        <span class="c1"># them as time zone information files, followed by</span>
        <span class="c1"># sixteen bytes reserved for future use, followed by</span>
        <span class="c1"># six four-byte values of type long, written in a</span>
        <span class="c1"># ``standard&#39;&#39; byte order (the high-order  byte</span>
        <span class="c1"># of the value is written first).</span>

        <span class="k">if</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;TZif&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;magic not found&quot;</span><span class="p">)</span>

        <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>

        <span class="p">(</span>
         <span class="c1"># The number of UTC/local indicators stored in the file.</span>
         <span class="n">ttisgmtcnt</span><span class="p">,</span>

         <span class="c1"># The number of standard/wall indicators stored in the file.</span>
         <span class="n">ttisstdcnt</span><span class="p">,</span>

         <span class="c1"># The number of leap seconds for which data is</span>
         <span class="c1"># stored in the file.</span>
         <span class="n">leapcnt</span><span class="p">,</span>

         <span class="c1"># The number of &quot;transition times&quot; for which data</span>
         <span class="c1"># is stored in the file.</span>
         <span class="n">timecnt</span><span class="p">,</span>

         <span class="c1"># The number of &quot;local time types&quot; for which data</span>
         <span class="c1"># is stored in the file (must not be zero).</span>
         <span class="n">typecnt</span><span class="p">,</span>

         <span class="c1"># The  number  of  characters  of &quot;time zone</span>
         <span class="c1"># abbreviation strings&quot; stored in the file.</span>
         <span class="n">charcnt</span><span class="p">,</span>

        <span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;6l&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span>

        <span class="c1"># The above header is followed by tzh_timecnt four-byte</span>
        <span class="c1"># values  of  type long,  sorted  in ascending order.</span>
        <span class="c1"># These values are written in ``standard&#39;&#39; byte order.</span>
        <span class="c1"># Each is used as a transition time (as  returned  by</span>
        <span class="c1"># time(2)) at which the rules for computing local time</span>
        <span class="c1"># change.</span>

        <span class="k">if</span> <span class="n">timecnt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trans_list</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;</span><span class="si">%d</span><span class="s2">l&quot;</span> <span class="o">%</span> <span class="n">timecnt</span><span class="p">,</span>
                                             <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">timecnt</span><span class="o">*</span><span class="mi">4</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trans_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Next come tzh_timecnt one-byte values of type unsigned</span>
        <span class="c1"># char; each one tells which of the different types of</span>
        <span class="c1"># ``local time&#39;&#39; types described in the file is associated</span>
        <span class="c1"># with the same-indexed transition time. These values</span>
        <span class="c1"># serve as indices into an array of ttinfo structures that</span>
        <span class="c1"># appears next in the file.</span>

        <span class="k">if</span> <span class="n">timecnt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trans_idx</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;</span><span class="si">%d</span><span class="s2">B&quot;</span> <span class="o">%</span> <span class="n">timecnt</span><span class="p">,</span>
                                            <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">timecnt</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trans_idx</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Each ttinfo structure is written as a four-byte value</span>
        <span class="c1"># for tt_gmtoff  of  type long,  in  a  standard  byte</span>
        <span class="c1"># order, followed  by a one-byte value for tt_isdst</span>
        <span class="c1"># and a one-byte  value  for  tt_abbrind.   In  each</span>
        <span class="c1"># structure, tt_gmtoff  gives  the  number  of</span>
        <span class="c1"># seconds to be added to UTC, tt_isdst tells whether</span>
        <span class="c1"># tm_isdst should be set by  localtime(3),  and</span>
        <span class="c1"># tt_abbrind serves  as an index into the array of</span>
        <span class="c1"># time zone abbreviation characters that follow the</span>
        <span class="c1"># ttinfo structure(s) in the file.</span>

        <span class="n">ttinfo</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iter_range</span><span class="p">(</span><span class="n">typecnt</span><span class="p">):</span>
            <span class="n">ttinfo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;lbb&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">6</span><span class="p">)))</span>

        <span class="n">abbr</span> <span class="o">=</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">charcnt</span><span class="p">)</span>

        <span class="c1"># Then there are tzh_leapcnt pairs of four-byte</span>
        <span class="c1"># values, written in  standard byte  order;  the</span>
        <span class="c1"># first  value  of  each pair gives the time (as</span>
        <span class="c1"># returned by time(2)) at which a leap second</span>
        <span class="c1"># occurs;  the  second  gives the  total  number of</span>
        <span class="c1"># leap seconds to be applied after the given time.</span>
        <span class="c1"># The pairs of values are sorted in ascending order</span>
        <span class="c1"># by time.</span>

        <span class="c1"># Not used, for now</span>
        <span class="k">if</span> <span class="n">leapcnt</span><span class="p">:</span>
            <span class="n">leap</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;</span><span class="si">%d</span><span class="s2">l&quot;</span> <span class="o">%</span> <span class="n">leapcnt</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span>
                                 <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">leapcnt</span><span class="o">*</span><span class="mi">8</span><span class="p">))</span>

        <span class="c1"># Then there are tzh_ttisstdcnt standard/wall</span>
        <span class="c1"># indicators, each stored as a one-byte value;</span>
        <span class="c1"># they tell whether the transition times associated</span>
        <span class="c1"># with local time types were specified as standard</span>
        <span class="c1"># time or wall clock time, and are used when</span>
        <span class="c1"># a time zone file is used in handling POSIX-style</span>
        <span class="c1"># time zone environment variables.</span>

        <span class="k">if</span> <span class="n">ttisstdcnt</span><span class="p">:</span>
            <span class="n">isstd</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;</span><span class="si">%d</span><span class="s2">b&quot;</span> <span class="o">%</span> <span class="n">ttisstdcnt</span><span class="p">,</span>
                                  <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ttisstdcnt</span><span class="p">))</span>

        <span class="c1"># Finally, there are tzh_ttisgmtcnt UTC/local</span>
        <span class="c1"># indicators, each stored as a one-byte value;</span>
        <span class="c1"># they tell whether the transition times associated</span>
        <span class="c1"># with local time types were specified as UTC or</span>
        <span class="c1"># local time, and are used when a time zone file</span>
        <span class="c1"># is used in handling POSIX-style time zone envi-</span>
        <span class="c1"># ronment variables.</span>

        <span class="k">if</span> <span class="n">ttisgmtcnt</span><span class="p">:</span>
            <span class="n">isgmt</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;</span><span class="si">%d</span><span class="s2">b&quot;</span> <span class="o">%</span> <span class="n">ttisgmtcnt</span><span class="p">,</span>
                                  <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ttisgmtcnt</span><span class="p">))</span>

        <span class="c1"># ** Everything has been read **</span>

        <span class="c1"># Build ttinfo list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iter_range</span><span class="p">(</span><span class="n">typecnt</span><span class="p">):</span>
            <span class="n">gmtoff</span><span class="p">,</span> <span class="n">isdst</span><span class="p">,</span> <span class="n">abbrind</span> <span class="o">=</span>  <span class="n">ttinfo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># Round to full-minutes if that&#39;s not the case. Python&#39;s</span>
            <span class="c1"># datetime doesn&#39;t accept sub-minute timezones. Check</span>
            <span class="c1"># http://python.org/sf/1447945 for some information.</span>
            <span class="n">gmtoff</span> <span class="o">=</span> <span class="p">(</span><span class="n">gmtoff</span><span class="o">+</span><span class="mi">30</span><span class="p">)</span><span class="o">//</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span>
            <span class="n">tti</span> <span class="o">=</span> <span class="n">_ttinfo</span><span class="p">()</span>
            <span class="n">tti</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">gmtoff</span>
            <span class="n">tti</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">gmtoff</span><span class="p">)</span>
            <span class="n">tti</span><span class="o">.</span><span class="n">isdst</span> <span class="o">=</span> <span class="n">isdst</span>
            <span class="n">tti</span><span class="o">.</span><span class="n">abbr</span> <span class="o">=</span> <span class="n">abbr</span><span class="p">[</span><span class="n">abbrind</span><span class="p">:</span><span class="n">abbr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">abbrind</span><span class="p">)]</span>
            <span class="n">tti</span><span class="o">.</span><span class="n">isstd</span> <span class="o">=</span> <span class="p">(</span><span class="n">ttisstdcnt</span> <span class="o">&gt;</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">isstd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">tti</span><span class="o">.</span><span class="n">isgmt</span> <span class="o">=</span> <span class="p">(</span><span class="n">ttisgmtcnt</span> <span class="o">&gt;</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">isgmt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tti</span><span class="p">)</span>

        <span class="c1"># Replace ttinfo indexes for ttinfo objects.</span>
        <span class="n">trans_idx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trans_idx</span><span class="p">:</span>
            <span class="n">trans_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_list</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trans_idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">trans_idx</span><span class="p">)</span>

        <span class="c1"># Set standard, dst, and before ttinfos. before will be</span>
        <span class="c1"># used when a given time is before any transitions,</span>
        <span class="c1"># and will be set to the first non-dst ttinfo, or to</span>
        <span class="c1"># the first dst, if all of them are dst.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_std</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_dst</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_before</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trans_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iter_range</span><span class="p">(</span><span class="n">timecnt</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">tti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trans_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_std</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tti</span><span class="o">.</span><span class="n">isdst</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_std</span> <span class="o">=</span> <span class="n">tti</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_dst</span> <span class="ow">and</span> <span class="n">tti</span><span class="o">.</span><span class="n">isdst</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_dst</span> <span class="o">=</span> <span class="n">tti</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_std</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_dst</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_dst</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_std</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_dst</span>

                <span class="k">for</span> <span class="n">tti</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">tti</span><span class="o">.</span><span class="n">isdst</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_before</span> <span class="o">=</span> <span class="n">tti</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Now fix transition times to become relative to wall time.</span>
        <span class="c1">#</span>
        <span class="c1"># I&#39;m not sure about this. In my tests, the tz source file</span>
        <span class="c1"># is setup to wall time, and in the binary file isstd and</span>
        <span class="c1"># isgmt are off, so it should be in wall time. OTOH, it&#39;s</span>
        <span class="c1"># always in gmt time. Let me know if you have comments</span>
        <span class="c1"># about this.</span>
        <span class="n">laststdoffset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trans_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trans_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iter_range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trans_list</span><span class="p">)):</span>
            <span class="n">tti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trans_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tti</span><span class="o">.</span><span class="n">isdst</span><span class="p">:</span>
                <span class="c1"># This is std time.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_trans_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tti</span><span class="o">.</span><span class="n">offset</span>
                <span class="n">laststdoffset</span> <span class="o">=</span> <span class="n">tti</span><span class="o">.</span><span class="n">offset</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This is dst time. Convert to std.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_trans_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">laststdoffset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trans_list</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trans_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_find_ttinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">laststd</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="p">((</span><span class="n">dt</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span> <span class="o">-</span> <span class="n">EPOCHORDINAL</span><span class="p">)</span> <span class="o">*</span> <span class="mi">86400</span>
                     <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">hour</span> <span class="o">*</span> <span class="mi">3600</span>
                     <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">minute</span> <span class="o">*</span> <span class="mi">60</span>
                     <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">trans</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trans_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">trans</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_std</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_before</span>
        <span class="k">if</span> <span class="n">laststd</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trans_idx</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">tti</span><span class="o">.</span><span class="n">isdst</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">tti</span>
                <span class="n">idx</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_std</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trans_idx</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<div class="viewcode-block" id="tzfile.utcoffset"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzfile.utcoffset">[docs]</a>    <span class="k">def</span> <span class="nf">utcoffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_std</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ZERO</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_ttinfo</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">delta</span></div>

<div class="viewcode-block" id="tzfile.dst"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzfile.dst">[docs]</a>    <span class="k">def</span> <span class="nf">dst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_dst</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ZERO</span>
        <span class="n">tti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_ttinfo</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tti</span><span class="o">.</span><span class="n">isdst</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ZERO</span>

        <span class="c1"># The documentation says that utcoffset()-dst() must</span>
        <span class="c1"># be constant for every dt.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_ttinfo</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">laststd</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">delta</span><span class="o">-</span><span class="n">tti</span><span class="o">.</span><span class="n">delta</span></div>

        <span class="c1"># An alternative for that would be:</span>
        <span class="c1">#</span>
        <span class="c1"># return self._ttinfo_dst.offset-self._ttinfo_std.offset</span>
        <span class="c1">#</span>
        <span class="c1"># However, this class stores historical changes in the</span>
        <span class="c1"># dst offset, so I belive that this wouldn&#39;t be the right</span>
        <span class="c1"># way to implement this.</span>

<div class="viewcode-block" id="tzfile.tzname"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzfile.tzname">[docs]</a>    <span class="k">def</span> <span class="nf">tzname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_std</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_ttinfo</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">abbr</span></div>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">tzfile</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trans_list</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_trans_list</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_trans_idx</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_trans_idx</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ttinfo_list</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_ttinfo_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unpickable </span><span class="si">%s</span><span class="s2"> class&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">,))</span></div>


<div class="viewcode-block" id="tzrange"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzrange">[docs]</a><span class="k">class</span> <span class="nc">tzrange</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stdabbr</span><span class="p">,</span> <span class="n">stdoffset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">dstabbr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dstoffset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">relativedelta</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">relativedelta</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">dateutil</span> <span class="k">import</span> <span class="n">relativedelta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_std_abbr</span> <span class="o">=</span> <span class="n">stdabbr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dst_abbr</span> <span class="o">=</span> <span class="n">dstabbr</span>
        <span class="k">if</span> <span class="n">stdoffset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">stdoffset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span> <span class="o">=</span> <span class="n">ZERO</span>
        <span class="k">if</span> <span class="n">dstoffset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">dstoffset</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dstabbr</span> <span class="ow">and</span> <span class="n">stdoffset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span><span class="o">+</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span> <span class="o">=</span> <span class="n">ZERO</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start_delta</span> <span class="o">=</span> <span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">(</span>
                    <span class="n">hours</span><span class="o">=+</span><span class="mi">2</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">weekday</span><span class="o">=</span><span class="n">relativedelta</span><span class="o">.</span><span class="n">SU</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start_delta</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_end_delta</span> <span class="o">=</span> <span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">(</span>
                    <span class="n">hours</span><span class="o">=+</span><span class="mi">1</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">31</span><span class="p">,</span> <span class="n">weekday</span><span class="o">=</span><span class="n">relativedelta</span><span class="o">.</span><span class="n">SU</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_end_delta</span> <span class="o">=</span> <span class="n">end</span>

<div class="viewcode-block" id="tzrange.utcoffset"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzrange.utcoffset">[docs]</a>    <span class="k">def</span> <span class="nf">utcoffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdst</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span></div>

<div class="viewcode-block" id="tzrange.dst"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzrange.dst">[docs]</a>    <span class="k">def</span> <span class="nf">dst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdst</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ZERO</span></div>

<div class="viewcode-block" id="tzrange.tzname"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzrange.tzname">[docs]</a>    <span class="k">def</span> <span class="nf">tzname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdst</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_abbr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std_abbr</span></div>

    <span class="k">def</span> <span class="nf">_isdst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_delta</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">year</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_delta</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">year</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_end_delta</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dt</span> <span class="o">&gt;=</span> <span class="n">start</span> <span class="ow">and</span> <span class="n">dt</span> <span class="o">&lt;</span> <span class="n">end</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dt</span> <span class="o">&gt;=</span> <span class="n">start</span> <span class="ow">or</span> <span class="n">dt</span> <span class="o">&lt;</span> <span class="n">end</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">tzrange</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_std_abbr</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_std_abbr</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dst_abbr</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_dst_abbr</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_std_offset</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_dst_offset</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_start_delta</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_start_delta</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_end_delta</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_end_delta</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(...)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="n">__reduce__</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__reduce__</span></div>


<div class="viewcode-block" id="tzstr"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzstr">[docs]</a><span class="k">class</span> <span class="nc">tzstr</span><span class="p">(</span><span class="n">tzrange</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">parser</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parser</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">dateutil</span> <span class="k">import</span> <span class="n">parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_s</span> <span class="o">=</span> <span class="n">s</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_parsetz</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unknown string format&quot;</span><span class="p">)</span>

        <span class="c1"># We must initialize it first, since _delta() needs</span>
        <span class="c1"># _std_offset and _dst_offset set. Use False in start/end</span>
        <span class="c1"># to avoid building it two times.</span>
        <span class="n">tzrange</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">stdabbr</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">stdoffset</span><span class="p">,</span>
                         <span class="n">res</span><span class="o">.</span><span class="n">dstabbr</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">dstoffset</span><span class="p">,</span>
                         <span class="n">start</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_delta</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_end_delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">isend</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">isend</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">month</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">month</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">weekday</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;weekday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relativedelta</span><span class="o">.</span><span class="n">weekday</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">weekday</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">week</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">week</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">31</span>
            <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">day</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">day</span>
        <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">yday</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;yearday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">yday</span>
        <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">jyday</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;nlyearday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">jyday</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c1"># Default is to start on first sunday of april, and end</span>
            <span class="c1"># on last sunday of october.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isend</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;weekday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relativedelta</span><span class="o">.</span><span class="n">SU</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">31</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;weekday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relativedelta</span><span class="o">.</span><span class="n">SU</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;seconds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">time</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Default is 2AM.</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;seconds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7200</span>
        <span class="k">if</span> <span class="n">isend</span><span class="p">:</span>
            <span class="c1"># Convert to standard time, to follow the documented way</span>
            <span class="c1"># of working with the extra hour. See the documentation</span>
            <span class="c1"># of the tzinfo class.</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_offset</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_std_offset</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;seconds&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">delta</span><span class="o">.</span><span class="n">seconds</span><span class="o">+</span><span class="n">delta</span><span class="o">.</span><span class="n">days</span><span class="o">*</span><span class="mi">86400</span>
        <span class="k">return</span> <span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_s</span><span class="p">))</span></div>


<span class="k">class</span> <span class="nc">_tzicalvtzcomp</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tzoffsetfrom</span><span class="p">,</span> <span class="n">tzoffsetto</span><span class="p">,</span> <span class="n">isdst</span><span class="p">,</span>
                       <span class="n">tzname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rrule</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tzoffsetfrom</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">tzoffsetfrom</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tzoffsetto</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">tzoffsetto</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tzoffsetdiff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tzoffsetto</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tzoffsetfrom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isdst</span> <span class="o">=</span> <span class="n">isdst</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tzname</span> <span class="o">=</span> <span class="n">tzname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rrule</span> <span class="o">=</span> <span class="n">rrule</span>


<span class="k">class</span> <span class="nc">_tzicalvtz</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tzid</span><span class="p">,</span> <span class="n">comps</span><span class="o">=</span><span class="p">[]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tzid</span> <span class="o">=</span> <span class="n">tzid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comps</span> <span class="o">=</span> <span class="n">comps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cachedate</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cachecomp</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_find_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_comps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cachecomp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cachedate</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dt</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">lastcomp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">lastcompdt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comps</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">comp</span><span class="o">.</span><span class="n">isdst</span><span class="p">:</span>
                <span class="c1"># Handle the extra hour in DST -&gt; STD</span>
                <span class="n">compdt</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">rrule</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="n">dt</span><span class="o">-</span><span class="n">comp</span><span class="o">.</span><span class="n">tzoffsetdiff</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">compdt</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">rrule</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">compdt</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">lastcompdt</span> <span class="ow">or</span> <span class="n">lastcompdt</span> <span class="o">&lt;</span> <span class="n">compdt</span><span class="p">):</span>
                <span class="n">lastcompdt</span> <span class="o">=</span> <span class="n">compdt</span>
                <span class="n">lastcomp</span> <span class="o">=</span> <span class="n">comp</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lastcomp</span><span class="p">:</span>
            <span class="c1"># RFC says nothing about what to do when a given</span>
            <span class="c1"># time is before the first onset date. We&#39;ll look for the</span>
            <span class="c1"># first standard component, or the first component, if</span>
            <span class="c1"># none is found.</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comps</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">comp</span><span class="o">.</span><span class="n">isdst</span><span class="p">:</span>
                    <span class="n">lastcomp</span> <span class="o">=</span> <span class="n">comp</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lastcomp</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cachedate</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cachecomp</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lastcomp</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cachedate</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cachedate</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cachecomp</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lastcomp</span>

    <span class="k">def</span> <span class="nf">utcoffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_comp</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">tzoffsetto</span>

    <span class="k">def</span> <span class="nf">dst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_comp</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">isdst</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">comp</span><span class="o">.</span><span class="n">tzoffsetdiff</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ZERO</span>

    <span class="k">def</span> <span class="nf">tzname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_comp</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">tzname</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;tzicalvtz </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tzid</span><span class="p">)</span>

    <span class="n">__reduce__</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__reduce__</span>


<div class="viewcode-block" id="tzical"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzical">[docs]</a><span class="k">class</span> <span class="nc">tzical</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">rrule</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rrule</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">dateutil</span> <span class="k">import</span> <span class="n">rrule</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_s</span> <span class="o">=</span> <span class="n">fileobj</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_s</span> <span class="o">=</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_s</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_vtz</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_rfc</span><span class="p">(</span><span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<div class="viewcode-block" id="tzical.keys"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzical.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">iter_keys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vtz</span><span class="p">))</span></div>

<div class="viewcode-block" id="tzical.get"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.tzical.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tzid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tzid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">iter_keys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vtz</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;no timezones defined&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;more than one timezone available&quot;</span><span class="p">)</span>
            <span class="n">tzid</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vtz</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tzid</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_parse_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;empty offset&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;+&#39;</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="mi">3600</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span><span class="o">*</span><span class="n">signal</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="mi">3600</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span><span class="o">*</span><span class="mi">60</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">4</span><span class="p">:]))</span><span class="o">*</span><span class="n">signal</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid offset: &quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_rfc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;empty string&quot;</span><span class="p">)</span>

        <span class="c1"># Unfold</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">:</span>
                <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">tzid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">comps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">invtz</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">comptype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">parms</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parms</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;empty property name&quot;</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">parms</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">invtz</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;BEGIN&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;STANDARD&quot;</span><span class="p">,</span> <span class="s2">&quot;DAYLIGHT&quot;</span><span class="p">):</span>
                        <span class="c1"># Process component</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unknown component: &quot;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">comptype</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="n">founddtstart</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">tzoffsetfrom</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tzoffsetto</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">rrulelines</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">tzname</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;VTIMEZONE&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">comptype</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;component not closed: &quot;</span> <span class="o">+</span> <span class="n">comptype</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">tzid</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mandatory TZID not found&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">comps</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;at least one component is needed&quot;</span><span class="p">)</span>
                        <span class="c1"># Process vtimezone</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_vtz</span><span class="p">[</span><span class="n">tzid</span><span class="p">]</span> <span class="o">=</span> <span class="n">_tzicalvtz</span><span class="p">(</span><span class="n">tzid</span><span class="p">,</span> <span class="n">comps</span><span class="p">)</span>
                        <span class="n">invtz</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="n">comptype</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">founddtstart</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mandatory DTSTART not found&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">tzoffsetfrom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mandatory TZOFFSETFROM not found&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">tzoffsetto</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mandatory TZOFFSETFROM not found&quot;</span><span class="p">)</span>
                        <span class="c1"># Process component</span>
                        <span class="n">rr</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">rrulelines</span><span class="p">:</span>
                            <span class="n">rr</span> <span class="o">=</span> <span class="n">rrule</span><span class="o">.</span><span class="n">rrulestr</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rrulelines</span><span class="p">),</span>
                                                <span class="n">compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">ignoretz</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">comp</span> <span class="o">=</span> <span class="n">_tzicalvtzcomp</span><span class="p">(</span><span class="n">tzoffsetfrom</span><span class="p">,</span> <span class="n">tzoffsetto</span><span class="p">,</span>
                                              <span class="p">(</span><span class="n">comptype</span> <span class="o">==</span> <span class="s2">&quot;DAYLIGHT&quot;</span><span class="p">),</span>
                                              <span class="n">tzname</span><span class="p">,</span> <span class="n">rr</span><span class="p">)</span>
                        <span class="n">comps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
                        <span class="n">comptype</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid component end: &quot;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">comptype</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;DTSTART&quot;</span><span class="p">:</span>
                        <span class="n">rrulelines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="n">founddtstart</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;RRULE&quot;</span><span class="p">,</span> <span class="s2">&quot;RDATE&quot;</span><span class="p">,</span> <span class="s2">&quot;EXRULE&quot;</span><span class="p">,</span> <span class="s2">&quot;EXDATE&quot;</span><span class="p">):</span>
                        <span class="n">rrulelines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;TZOFFSETFROM&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">parms</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported </span><span class="si">%s</span><span class="s2"> parm: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="n">tzoffsetfrom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_offset</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;TZOFFSETTO&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">parms</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported TZOFFSETTO parm: &quot;</span> <span class="o">+</span> <span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">tzoffsetto</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_offset</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;TZNAME&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">parms</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported TZNAME parm: &quot;</span> <span class="o">+</span> <span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">tzname</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;COMMENT&quot;</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported property: &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;TZID&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">parms</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported TZID parm: &quot;</span> <span class="o">+</span> <span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">tzid</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;TZURL&quot;</span><span class="p">,</span> <span class="s2">&quot;LAST-MODIFIED&quot;</span><span class="p">,</span> <span class="s2">&quot;COMMENT&quot;</span><span class="p">):</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported property: &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;BEGIN&quot;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;VTIMEZONE&quot;</span><span class="p">:</span>
                <span class="n">tzid</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">comps</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">invtz</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_s</span><span class="p">))</span></div>


<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
    <span class="n">TZFILES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/etc/localtime&quot;</span><span class="p">,</span> <span class="s2">&quot;localtime&quot;</span><span class="p">]</span>
    <span class="n">TZPATHS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/usr/share/zoneinfo&quot;</span><span class="p">,</span> <span class="s2">&quot;/usr/lib/zoneinfo&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/zoneinfo&quot;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">TZFILES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">TZPATHS</span> <span class="o">=</span> <span class="p">[]</span>


<div class="viewcode-block" id="gettz"><a class="viewcode-back" href="../../miscellaneous.html#storm.tz.gettz">[docs]</a><span class="k">def</span> <span class="nf">gettz</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">tz</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TZ&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;:&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">TZFILES</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">filepath</span>
                <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">TZPATHS</span><span class="p">:</span>
                    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tz</span> <span class="o">=</span> <span class="n">tzfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tz</span> <span class="o">=</span> <span class="n">tzlocal</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="n">tz</span> <span class="o">=</span> <span class="n">tzfile</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tz</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">TZPATHS</span><span class="p">:</span>
                <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                    <span class="n">filepath</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                        <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tz</span> <span class="o">=</span> <span class="n">tzfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tz</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">tzwin</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tz</span> <span class="o">=</span> <span class="n">tzwin</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">tz</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">dateutil.zoneinfo</span> <span class="k">import</span> <span class="n">gettz</span>
                    <span class="n">tz</span> <span class="o">=</span> <span class="n">gettz</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">tz</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                        <span class="c1"># name must have at least one offset to be a tzstr</span>
                        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="s2">&quot;0123456789&quot;</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">tz</span> <span class="o">=</span> <span class="n">tzstr</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;GMT&quot;</span><span class="p">,</span> <span class="s2">&quot;UTC&quot;</span><span class="p">):</span>
                            <span class="n">tz</span> <span class="o">=</span> <span class="n">tzutc</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">time</span><span class="o">.</span><span class="n">tzname</span><span class="p">:</span>
                            <span class="n">tz</span> <span class="o">=</span> <span class="n">tzlocal</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">tz</span></div>

<span class="c1"># vim:ts=4:sw=4:et</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Gustavo Niemeyer.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>